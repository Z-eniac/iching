<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DIVINA: customize</title>
<link rel="icon" type="image/svg+xml" href="icon/No49.svg">
<link rel="apple-touch-icon" sizes="180x180" href="icon/No49.png">
<link rel="preload" href="./assets/fonts/NotoSerifCJKkr-Semibold-iching.woff2" as="font" type="font/woff2" crossorigin>
<style>
  @font-face{
  font-family:"NotoSerifCJK-ICHING";
  src:url("./assets/fonts/NotoSerifCJKkr-Semibold-iching.woff2") format("woff2");
  font-weight:600; font-style:normal; font-display:swap;
}
h1{ font-family:"NotoSerifCJK-ICHING","Source Han Serif K",serif; font-weight:600;text-align:center;margin-top:46px;margin-bottom:30px}
.title .han{ font-family:"NotoSerifCJK-ICHING","Source Han Serif K",serif; }
  
  :root{
    --bg:#0c111b; --card:#111a2b; --border:#22304a; --ink:#eaf0ff;
    --muted:#a8b6d7; --accent:#2b8cff; --yang:#e7eefc; --yin:#e7eefc; --mark:#ff6b6b;
    --hexWidth: 192px; --lineHeight: 24px; --rowGap: 12px; --yinGap: 26px;
    --contentMax: 1200px;
    --cardW: 400px; --cardGap: 18px; /* more compact cards */
    --metaCol1: 40px; --metaCol2: 80px; --metaCol3: 50px; --metaCol4: 100px; --metaCol5: 58px; /* tighter grid */
          /* === Brand size knobs === */
        --brandLogoSize: 140px;      /* 로고(정사각) 크기 */
        --brandTypeWidth: 205px;     /* 로고타입(svg 글자) 가로폭 */
        --brandGap: 12px;            /* 둘 사이 간격 */    
  }
   
  /* 요지(한 줄 요약) */
  .hex-gist{
  font-family: "NotoSerifCJK-ICHING","Source Han Serif K",serif;
  font-weight: 600;
  font-synthesis: none;
  }
  h1,
  .page-title {                /* 페이지 최상단 타이틀에 쓰는 클래스가 있으면 같이 */
  font-family: "NotoSerifCJK-ICHING", serif !important;
  font-weight: 600 !important;
  font-synthesis: none;      /* 가짜 볼드 방지 */
  letter-spacing:0em;     /* 취향 보정 */
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,'Malgun Gothic',Segoe UI,Roboto,sans-serif}
  a{color:inherit}
  h1{font-size:50px;text-align:center;letter-spacing:0px;margin-top:46px;margin-bottom:30px}
  h2{font-family:"NotoSerifCJK-ICHING",serif;margin:8px 0 14px;text-align:center;font-size:26px;color:var(--ink)}
  .wrap{max-width:var(--contentMax);margin:0 auto;padding:0 16px 40px}

  .brandWrap{
  display:flex; flex-direction:column; align-items:center;
  gap:var(--brandGap);
  margin: 25px 0 6px;          /* 상단 여백 조절 */
  }
  .brandWrap a{ display:inline-block; text-decoration:none; }
  .brandLogo{ width:var(--brandLogoSize); height:auto; }
  .brandType{ width:min(var(--brandTypeWidth), 84vw); height:auto; }

  /* 스크린리더/SEO용 숨김 텍스트 */
  .sr-only{
  position:absolute !important; width:1px; height:1px; padding:0; margin:-1px;
  overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;
  }
  
  .btn{background:#68313f;color:#fff;border:0;border-radius:12px;padding:14px 20px;font-weight:700;cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,.2);font-size:1.1rem}
  .btn.subtle{background:#243552;color:#cfe0ff;border:1px solid #2a3b5a}
  .row{display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap;justify-content:center}
  .card{flex:0 1 400px;max-width:480px;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.25)}
  .badge{display:inline-block;background:#1a2540;border:1px solid #2c3b58;border-radius:10px;padding:4px 10px;margin-bottom:10px}
  .title{text-align:center;margin:6px 0 16px}
  .title .han{font-size:45px;letter-spacing:1px;font-weight:700}
  .title .ko{font-size:14px;color:var(--muted);margin-top:4px}

  /* 카드 타이틀을 클릭 가능한 링크로 */
  .title a{ color: inherit; text-decoration: none; }
  .title a:focus-visible{ outline: 2px solid var(--accent); outline-offset: 2px; border-radius: 6px; }

  /* 기본 링크 모양 */
.title a, .titleLink{
  position: relative;
  display: inline-block;
  color: inherit;
  text-decoration: none;
}

/* 두 줄(한자/국문) 각각 오버레이 준비 */
.titleLink .han,
.titleLink .ko{
  position: relative;
  display: block;
}

/* 라디얼 스팟: 같은 텍스트를 위에 겹치고, 그라데를 '글자 내부'에만 채움 */
.titleLink .han::after,
.titleLink .ko::after{
  content: attr(data-text);       /* JS로 원문 복사해 줄 거야 */
  position: absolute;
  inset: 0;
  pointer-events: none;

  /* 글자 내부만 보이게 */
  color: transparent;
  background:
    radial-gradient(220px 220px at var(--mx, 50%) var(--my, 50%),
      rgba(245, 203, 170, 0.95) 0%,
      rgba(245, 205, 170, 0.45) 28%,
      rgba(245, 216, 170, 0.1) 52%,
      rgba(245, 215, 170, 0) 65%);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;

  opacity: 0;                     /* 기본은 숨김 */
  transition: opacity 180ms ease-out, filter 180ms ease-out;
  filter: saturate(1.05) brightness(1.06); /* 살짝 윤기 */
}

/* 호버/포커스 시 스팟 등장 */
.titleLink:hover .han::after,
.titleLink:hover .ko::after,
.titleLink:focus-visible .han::after,
.titleLink:focus-visible .ko::after{
  opacity: 1;
}

/* 접근성: 키보드 포커스 시 중앙에 스팟 고정 */
.titleLink:focus-visible{
  outline: 2px solid var(--accent, #c7854b);
  outline-offset: 2px;
  border-radius: 8px;
}
.titleLink:focus-visible{ --mx: 50%; --my: 50%; }

/* 모션 민감 사용자 배려 
@media (prefers-reduced-motion: reduce){
  .titleLink .han::after,
  .titleLink .ko::after{ transition: opacity 0.01s linear; }
}*/

  .hex{min-width: calc(26px + var(--hexWidth) + 26px); display:grid;grid-template-columns:26px auto 26px;row-gap:var(--rowGap);align-items:center}
  .lab{font-size:11px;color:#c2cfe9;text-align:center;padding-top:2px}
  .sp{width:26px;height:var(--lineHeight)}
  .lineWrap{position:relative;width:var(--hexWidth);height:var(--lineHeight);justify-self:center}
  .line{height:100%;border-radius:7px;background:#25324a;position:absolute;inset:0}
  .yang .line::before{content:'';position:absolute;inset:2px;background:#e7eefc;border-radius:5px;box-shadow:inset 0 0 0 1px rgba(0,0,0,.05)}
  .yin .line::before,.yin .line::after{content:'';position:absolute;top:2px;bottom:2px;width:calc(50% - (var(--yinGap)/2));background:#e7eefc;border-radius:5px;box-shadow:inset 0 0 0 1px rgba(0,0,0,.05)}
  .yin .line::before{left:2px} .yin .line::after{right:2px}
  .yin .gap{position:absolute;left:50%;top:2px;bottom:2px;transform:translateX(-50%);width:var(--yinGap);background:#111a2b;border-radius:4px;box-shadow:0 0 0 1px rgba(0,0,0,.12) inset}
  .chg::after{content:'變';position:absolute;right:-8px;top:-4px;background:var(--mark);color:#fff;font-weight:700;font-size:11px;line-height:16px;padding:0 6px;border-radius:6px;box-shadow:0 1px 6px rgba(0,0,0,.3)}
  .unset .line::before{content:'';position:absolute;inset:2px;background:#162338;border-radius:5px;box-shadow:inset 0 0 0 1px rgba(0,0,0,.06)}

  .metaUnder{border-top:1px dashed #2a3b5a;margin-top:8px;padding-top:6px;text-align:center;width:100%}
  .metaRow{display:grid;grid-template-columns:40px 80px 50px 100px 58px;align-items:center;justify-items:start;column-gap:6px;margin:2px 0}
  .metaRow .lab2{color:#a9b8dc;justify-self:start;padding-right:2px}
  .metaRow .mono{font-variant-numeric:tabular-nums}
  .read{margin-top:8px;padding:8px 10px;border:1px solid #2a3b5a;border-radius:10px;background:#1b2b47}
  .read h4{margin:0 0 6px;font-size:15px;color:#cfe0ff}
  .read ul{margin:6px 0 0 18px;padding:0;line-height:1.45}
  .joint{margin-top:22px;padding:28px 28px;border:1px solid #2a3b5a;border-radius:16px;background:#0e172a;text-align:left;width:calc((2 * var(--cardW)) + var(--cardGap));margin-left:auto;margin-right:auto}
  .joint .summary{font-size:25px;font-weight:800;margin:0 0 20px;text-align:center}
  .joint .detail{font-size:17px;line-height:2.0;white-space:pre-line}
  
  .landing{font-weight:300;line-height:1.6;color:#a9b8dc;display:flex;flex-direction:column;align-items:center;text-align:center;}
  .landing .small{color:#fff;display:block;font-size:20px;font-weight:700;text-align:center}
  .landing .center{display:flex;justify-content:center}
  .intro textarea{margin:8px;max-width:500px;width:100%;min-height:140px;background:#0b1324;border:1px solid #2a3b5a;border-radius:12px;color:var(--ink);padding:14px;font-size:16px}
  
  .qWrap{display:flex;flex-direction:column;align-items:center;gap:10px}
  .qWrap textarea{width:min(780px, 92vw);min-height:90px;background:#0f1a2d;color:var(--ink);border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:16px;line-height:1.5}

  .customUI{
  display:grid;
  grid-template-columns:max-content max-content;
  gap:12px;
  width:max-content;
  margin:10px auto 0;
  justify-content:center;
  }
  .selCol{
  position:relative; z-index:2;
  display:grid;
  grid-template-rows:repeat(6, var(--lineHeight));
  row-gap:var(--rowGap);
  justify-items:end;
  }
  .selCol select{width:var(--selW);min-width:var(--selW);max-width:var(--selW);background:#13233d;color:#e9f0ff;border:1px solid #2b3b5b;border-radius:8px;height:var(--lineHeight);font-size:13px;text-align-last:center;-moz-text-align-last:center}
  .prevCol{ position:relative; z-index:1; pointer-events:none;}
    .prevCol .hex{ grid-template-columns:26px auto 0 !important; }
    .prevCol .lab{ grid-column: 1;text-align:center}
  .warn{color:#f52059;font-weight:400;margin-top:10px;margin-bottom:10px}
  .hidden{display:none !important;}
  .sub{color:var(--muted); font-weight:300; font-size:14px; text-align:center; line-height:1.6;margin:14px 0 24px}
  .panel{display:grid;grid-template-columns:auto;gap:10px;align-items:center;justify-items:center}
  .hex{display:grid;grid-template-columns:26px auto 26px;row-gap:var(--rowGap);align-items:center}
  .lab{text-align:center;font-size:11px;color:#c2cfe9;padding-top:2px}
  
  .gist{margin:10px 0 8px;text-align:center}
  .gist .gistLabel{font-size:14px;color:#9fb1d4;margin-bottom:4px}
  .gist .gistText{font-size:26px;font-family:"NotoSerifCJK-ICHING","Source Han Serif K",serif; font-weight:600; }
  @media (max-width:560px){ .gist .gistText{font-size:22px} }
    
  .ai{margin-top:18px;padding:18px;border:1px dashed #2a3b5a;border-radius:12px;background:#0f1a2d}
  .ai h4{margin:0 0 8px}

  @media (max-width: 560px){
    .customUI{grid-template-columns:auto 1fr;gap:10px}
    .selCol select{font-size:12px}
  }
  
  @media (max-width:940px){
    .card{flex-basis:100%;max-width:480px}
    .joint{width:auto}
  }

  /* ---- lines reveal animation (coins와 동일) ---- */
#baseHex .lineWrap .line,
#mutHex  .lineWrap .line{
  transition: opacity .28s ease, transform .28s ease;
}

/* 애니 중엔 숨김 — revealed 붙은 것만 보이게 */
#baseHex.animating .lineWrap:not(.revealed) .line,
#mutHex.animating  .lineWrap:not(.revealed) .line{
  opacity: 0;
  transform: scaleX(.92);
}

/* 기본: 배지는 항상 보임 */
.lineWrap.chg::after{
  opacity: 1;
  transform: none;
  transition: opacity .28s ease, transform .28s ease;
}

/* 결과 카드 애니메이션 중에만 숨겼다가 revealed 때 보이게 */
#baseHex.animating .lineWrap.chg::after,
#mutHex.animating  .lineWrap.chg::after{
  opacity: 0;
  transform: translateY(-4px);
}
#baseHex.animating .lineWrap.revealed.chg::after,
#mutHex.animating  .lineWrap.revealed.chg::after{
  opacity: 1;
  transform: translateY(0);
}

/* 살짝 튕김 */
@keyframes tossPulse{
  0%{transform:scaleX(.92)} 60%{transform:scaleX(1.02)} 100%{transform:scaleX(1)}
}
#baseHex.animating .lineWrap.revealed .line,
#mutHex.animating  .lineWrap.revealed .line{
  opacity:1; transform:scaleX(1); animation:tossPulse .28s ease-out;
}

/* 카드/공유해석 텍스트는 애니 끝에 한꺼번에 나타나게 */
.card .title, .card .gist, .card .metaUnder, .card .read{ transition: opacity 1s ease, transform 1s ease; }
.card.animating .title, .card.animating .gist, .card.animating .metaUnder, .card.animating .read{ opacity:0; transform:translateY(6px); }

.joint{ transition: opacity 1s ease, transform 1s ease; }
.joint.animating{ opacity:0; transform:translateY(6px); }

/* 첫 프레임 깜빡임 방지용 */
.card.prehide .title, .card.prehide .gist, .card.prehide .metaUnder, .card.prehide .read,
.joint.prehide{ opacity:0; transform:translateY(6px); transition:none !important; }

  /* joint 내부 로딩 UI (점 3개) */
.joint.loading{position:relative}
.joint .loader{display:flex;gap:8px;justify-content:center;align-items:center;padding:12px 0}
.joint .loader span{width:8px;height:8px;border-radius:50%;background:#8aa8ff;display:inline-block;animation:blip 1s infinite ease-in-out}
.joint .loader span:nth-child(2){animation-delay:.15s}
.joint .loader span:nth-child(3){animation-delay:.3s}
@keyframes blip{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}

/* rotating-square loader (scoped) */
.joint .loader svg{ display:inline-block; }
.joint .loader .sq-outer,
.joint .loader .sq-mid,
.joint .loader .sq-inner{
  transform-box: view-box;          /* SVG transform 기준 */
  transform-origin: 256px 256px;    /* viewBox가 0 0 512 512 → 중앙 */
  will-change: transform;
}
  
  /* brandWrap 안의 실제 콘텐츠 영역은 가로 100%로 펼치기 */
.brandWrap > #readingUI,
.brandWrap > #landingUI,
.brandWrap > #result{ 
  align-self: stretch;
  width: 100%;
}

  /* brandWrap 자식은 기본 가로로 늘리고, 로고(anchor)만 가운데 정렬 */
.brandWrap{ align-items: stretch; }
.brandWrap > a{ align-self: center; }  /* 로고 링크만 가운데 */

  /* 1) brandWrap 자식은 기본 가로로 늘리고, 로고(anchor)만 가운데 */
.brandWrap{ align-items: stretch; }
.brandWrap > a{ align-self: center; }  /* 로고 링크만 가운데 정렬 */

/* 2) 섹션/디브 블록들은 폭을 부모(.wrap)까지 꽉 채우기 */
.brandWrap > section,
.brandWrap > div{
  width: 100%;
  align-self: stretch;
}

/* 3) 커스텀 페이지 결과 섹션이 혹시 매칭 안 될 경우를 대비한 직접 타겟 */
.brandWrap > #result{ width:100%; align-self:stretch; }

/* 4) 최후 보강: .row 자체에 최대폭을 지정해 중앙 정렬(부모 폭 계산이 꼬여도 옆배치 되게) */
#result .row{
  max-width: var(--contentMax, 1200px);
  margin-left:auto;
  margin-right:auto;
}

/* 순차 등장: 기본 상태(숨김) + 항상 transition 적용 */
.js-reveal,
[data-reveal-group] > * {
  opacity: 0;
  transform: translateY(8px);
  filter: blur(2px);
  transition: opacity .6s ease, transform .6s ease, filter .6s ease;
  will-change: opacity, transform, filter;
}

/* 보일 때 */
.js-reveal.show,
[data-reveal-group] > *.show {
  opacity: 1;
  transform: translateY(0);
  filter: blur(0);
}

/* 모션 저감 사용자의 경우:
   - 이동/블러만 제거 (깜빡임 최소화)
   - transition은 끄지만, opacity는 기본 0을 유지 → JS로 순차 노출은 그대로 */
/*@media (prefers-reduced-motion: reduce) {
  .js-reveal,
  [data-reveal-group] > * {
    transform: none !important;
    filter: none !important;
    transition: none !important;
  }
}*/
  
</style>
</head>
<body>
<div class="wrap">
  <!-- 시멘틱/SEO 유지를 위한 숨김 h1 -->
  <h1 class="sr-only">Divina Studio</h1>
  <!-- 브랜드 블록: 위 로고, 아래 로고타입 -->
  <div class="brandWrap">
  <!-- 로고: 클릭 시 index.html 이동 -->
  <a href="index.html" aria-label="Divina Studio Home">
    <img src="./icon/No49.svg" alt="Divina logo" class="brandLogo">
  </a>
<h2 class="js-reveal">주역점: 커스텀</h2>
  <!-- 랜딩: 질문 + (좌)선택 / (우)본괘 미리보기 -->
  <section id="landingUI" class="intro landing">
    <p class="js-reveal">상황과 질문을 상세히 입력해 주세요.<br>미입력 시 기본 점괘 해석만 제공됩니다.<br></p>
    <label class="small js-reveal" for="userQuestion">질문 입력</label>
        <textarea class="js-reveal" id="userQuestion" 
      placeholder="예: 이번 이직 제안이 내게 유리할까? 연봉 협상에서 유의점은?"
      maxlength="300" aria-describedby="userQuestionCount"></textarea>
    <div class="charCounter js-reveal" id="userQuestionCount" aria-live="polite">0/300</div>
    <div class="center js-reveal" style="margin-top:10px;margin-bottom:20px">

    <div id="customUI" class="customUI">
      <!-- (좌) 선택란: 정적 6개(6→1효) -->
      <div class="selCol" id="selCol">
        <select data-idx="5"><option value="">선택</option><option value="6">노음</option><option value="7">소양</option><option value="8">소음</option><option value="9">노양</option></select>
        <select data-idx="4"><option value="">선택</option><option value="6">노음</option><option value="7">소양</option><option value="8">소음</option><option value="9">노양</option></select>
        <select data-idx="3"><option value="">선택</option><option value="6">노음</option><option value="7">소양</option><option value="8">소음</option><option value="9">노양</option></select>
        <select data-idx="2"><option value="">선택</option><option value="6">노음</option><option value="7">소양</option><option value="8">소음</option><option value="9">노양</option></select>
        <select data-idx="1"><option value="">선택</option><option value="6">노음</option><option value="7">소양</option><option value="8">소음</option><option value="9">노양</option></select>
        <select data-idx="0"><option value="">선택</option><option value="6">노음</option><option value="7">소양</option><option value="8">소음</option><option value="9">노양</option></select>
      </div>

      <!-- (우) 본괘 미리보기: 기본 미선택 상태 -->
      <div class="prevCol">
        <div class="hex" id="prevBaseHex">
          <div class="lab">6</div><div class="lineWrap unset"><div class="line"></div></div>
          <div class="lab">5</div><div class="lineWrap unset"><div class="line"></div></div>
          <div class="lab">4</div><div class="lineWrap unset"><div class="line"></div></div>
          <div class="lab">3</div><div class="lineWrap unset"><div class="line"></div></div>
          <div class="lab">2</div><div class="lineWrap unset"><div class="line"></div></div>
          <div class="lab">1</div><div class="lineWrap unset"><div class="line"></div></div>
        </div>
      </div>
    </div>
    </div>
    <div id="msg" class="warn hidden">점괘를 모두 입력해주세요.</div>

    <div style="display:flex;justify-content:center;margin-top:14px;gap:10px">
      <button id="btnRun" class="btn js-reveal">제출 및 점괘 실행</button>
    </div>
  </section>

  <!-- 결과 -->
  <section id="result" class="hidden">
    <div class="sub">입력하신 점괘를 적용했어요.<br>해석은 하단에 있습니다.</div>
    <div class="row">
      <div class="card" id="cardBase">
        <div class="badge">본괘</div>
        <div class="title" id="baseTitle"></div>
        <div class="panel" id="panelBase">        
          <div class="hex" id="baseHex"></div>
          <div class="gist" id="basegist"></div>
          <div class="metaUnder" id="baseMeta"></div>
        </div>
        <div class="read" id="baseRead"></div>
      </div>
      <div class="card" id="cardMut">
        <div class="badge">변괘</div>
        <div class="title" id="mutTitle"></div>
        <div class="panel" id="panelMut">        
          <div class="hex" id="mutHex"></div>
          <div class="gist" id="mutgist"></div>
          <div class="metaUnder" id="mutMeta"></div>
        </div>
        <div class="read" id="mutRead"></div>
      </div>
    </div>

  <div class="joint" id="jointBox">
    <div class="summary" id="jointSummary">해석 준비중…</div>
    <div class="detail" id="jointText"></div>
  </div>

    <div style="display:flex;justify-content:center;margin-top:18px">
      <a class="btn subtle" href="index.html">돌아가기</a>
    </div>
  </section>

  <div class="legend" style="text-align:center;margin-top:18px;font-size:12px;color:#a4b2d4">© 2025. 妙公 (Myo Gong). All Rights Reserved.</div>
</div>

<pre id="dbg" style="display:none;position:fixed;right:10px;bottom:10px;max-width:46vw;background:#111a2a;color:#e7efff;border:1px solid #2e3c5a;border-radius:10px;padding:10px 12px;font:12px/1.5 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;z-index:9999;white-space:pre-wrap"></pre>
<script>
const dbg=document.getElementById('dbg');
function log(){ dbg.style.display='block'; dbg.textContent += Array.from(arguments).join(' ') + "\n"; }
window.addEventListener('keydown',e=>{ if(e.shiftKey && e.key.toLowerCase()==='d'){ dbg.style.display = (dbg.style.display==='none'?'block':'none'); }});
</script>

<script>

  /* --- overrides loader (coins와 동일) --- */
(function(){
  const OVERRIDES_BASE_PATH = './overrides';
  const BUILD_VERSION = 'v2'; // 캐시 갱신용

  const pad2 = n => String(n).padStart(2, '0');

  async function __overrideLoad(baseNo, targetNo){
    const url = `${OVERRIDES_BASE_PATH}/overrides_base_${pad2(baseNo)}_domains.json?v=${BUILD_VERSION}`;
    try{
      const res = await fetch(url);
      if(!res.ok) throw new Error('HTTP '+res.status);
      const data = await res.json();
      return data[String(targetNo)] || null;   // 없으면 null
    }catch(e){
      console.warn('override fetch fail', e);
      return null;
    }
  }
  // 전역 노출(안전 범위)
  window.__overrideLoad = __overrideLoad;
})();

/* 라벨 제거 유틸(동전법과 동일) */
function stripLabelsInline(t){
  // 요약 한 줄에서 " · 핵심: …", " · 상세: …" 꼬리 제거
  return (t||'').replace(/\s*[·•]?\s*(핵심|상세)\s*:\s*[^\n\r]*/g, '')
                .replace(/\s{2,}/g,' ')
                .trim();
}
function stripLabelsInDetail(t){
  // 본문에서 "핵심:" 줄은 통째로 제거, "상세:"는 라벨만 지우고 뒤 내용 보존
  if(!t) return '';
  return t.split(/\r?\n/).map(l=>{
    if(/^\s*[·•]?\s*핵심\s*:/.test(l)) return '';
    return l.replace(/^\s*[·•]?\s*상세\s*:\s*/, '');
  }).filter(Boolean).join('\n');
}
  
/******** 데이터 & 유틸 ********/
const TRIS=['坤','震','坎','兌','艮','離','巽','乾'];
const TRIS_KO={'坤':'곤','震':'진','坎':'감','艮':'간','巽':'손','離':'리','兌':'태','乾':'건'};
const TRI_MEAN_HAN={'乾':'天','坤':'地','坎':'水','離':'火','震':'雷','巽':'風','艮':'山','兌':'澤'};
const TRI_ATTR_KO={'乾':'천','坤':'지','坎':'수','離':'화','震':'뇌','巽':'풍','艮':'산','兌':'택'};
const TRI_META={"乾":{"attrHan":"天","attrKo":"천","elem":"金","meaning":"권위·결단","dir":"서북","arrow":"↖"},"坤":{"attrHan":"地","attrKo":"지","elem":"土","meaning":"수용·양육","dir":"서남","arrow":"↙"},"坎":{"attrHan":"水","attrKo":"수","elem":"水","meaning":"심연·위험","dir":"북","arrow":"↑"},"離":{"attrHan":"火","attrKo":"화","elem":"火","meaning":"빛·분별","dir":"남","arrow":"↓"},"震":{"attrHan":"雷","attrKo":"뇌","elem":"木","meaning":"각성·시작","dir":"동","arrow":"→"},"巽":{"attrHan":"風","attrKo":"풍","elem":"木","meaning":"침투·확산","dir":"동남","arrow":"↘"},"艮":{"attrHan":"山","attrKo":"산","elem":"土","meaning":"멈춤·경계","dir":"동북","arrow":"↗"},"兌":{"attrHan":"澤","attrKo":"택","elem":"金","meaning":"기쁨·교류","dir":"서","arrow":"←"}};
const META={"u乾l乾":{"no":1,"nameHan":"乾","nameKo":"건","upper":"乾","lower":"乾","summary":"창조와 시작, 강건한 추진력"},"u坤l坤":{"no":2,"nameHan":"坤","nameKo":"곤","upper":"坤","lower":"坤","summary":"포용과 순응, 넓은 수용력"},"u坎l震":{"no":3,"nameHan":"屯","nameKo":"둔","upper":"坎","lower":"震","summary":"초기 난관, 인내로 방향을 잡아라"},"u艮l坎":{"no":4,"nameHan":"蒙","nameKo":"몽","upper":"艮","lower":"坎","summary":"미덥지 못함, 배움과 길잡이 필요"},"u坎l乾":{"no":5,"nameHan":"需","nameKo":"수","upper":"坎","lower":"乾","summary":"때를 기다림, 준비된 인내"},"u乾l坎":{"no":6,"nameHan":"訟","nameKo":"송","upper":"乾","lower":"坎","summary":"다툼과 논쟁, 원칙과 절제가 해법"},"u坤l坎":{"no":7,"nameHan":"師","nameKo":"사","upper":"坤","lower":"坎","summary":"조직과 규율, 리더십이 필요"},"u坎l坤":{"no":8,"nameHan":"比","nameKo":"비","upper":"坎","lower":"坤","summary":"결합과 친화, 신의 지키기"},"u巽l乾":{"no":9,"nameHan":"小畜","nameKo":"소축","upper":"巽","lower":"乾","summary":"작게 모아 힘을 기르는 때"},"u乾l兌":{"no":10,"nameHan":"履","nameKo":"리","upper":"乾","lower":"兌","summary":"예절과 절도 속의 전진"},"u坤l乾":{"no":11,"nameHan":"泰","nameKo":"태","upper":"坤","lower":"乾","summary":"소통과 상생, 형통함"},"u乾l坤":{"no":12,"nameHan":"否","nameKo":"비","upper":"乾","lower":"坤","summary":"막힘과 단절, 접촉면을 넓혀라"},"u乾l離":{"no":13,"nameHan":"同人","nameKo":"동인","upper":"乾","lower":"離","summary":"공동체와 연대, 뜻을 함께함"},"u離l乾":{"no":14,"nameHan":"大有","nameKo":"대유","upper":"離","lower":"乾","summary":"풍요와 성취, 명성과 소유"},"u坤l艮":{"no":15,"nameHan":"謙","nameKo":"겸","upper":"坤","lower":"艮","summary":"겸손과 절제, 낮을수록 단단하다"},"u震l坤":{"no":16,"nameHan":"豫","nameKo":"예","upper":"震","lower":"坤","summary":"즐거운 준비, 기획과 예비"},"u兌l震":{"no":17,"nameHan":"隨","nameKo":"수","upper":"兌","lower":"震","summary":"따름과 순응, 유연한 전환"},"u艮l巽":{"no":18,"nameHan":"蠱","nameKo":"고","upper":"艮","lower":"巽","summary":"폐단을 고치고 기반을 수리하라"},"u坤l兌":{"no":19,"nameHan":"臨","nameKo":"림","upper":"坤","lower":"兌","summary":"다가감·접근, 상호성"},"u巽l坤":{"no":20,"nameHan":"觀","nameKo":"관","upper":"巽","lower":"坤","summary":"관찰과 통찰, 큰 그림 보기"},"u離l震":{"no":21,"nameHan":"噬嗑","nameKo":"서합","upper":"離","lower":"震","summary":"결단과 집행, 악을 씹어 없애라"},"u艮l離":{"no":22,"nameHan":"賁","nameKo":"비","upper":"艮","lower":"離","summary":"치장과 표현, 아름다움의 배치"},"u艮l坤":{"no":23,"nameHan":"剝","nameKo":"박","upper":"艮","lower":"坤","summary":"깎여 나감, 쇠퇴 속 전환 준비"},"u坤l震":{"no":24,"nameHan":"復","nameKo":"복","upper":"坤","lower":"震","summary":"되돌아옴, 회복과 재기의 시작"},"u乾l震":{"no":25,"nameHan":"無妄","nameKo":"무망","upper":"乾","lower":"震","summary":"사심 없음, 자연스러움이 길"},"u艮l乾":{"no":26,"nameHan":"大畜","nameKo":"대축","upper":"艮","lower":"乾","summary":"큰 길들임, 축적과 자제"},"u艮l震":{"no":27,"nameHan":"頤","nameKo":"이","upper":"艮","lower":"震","summary":"양육과 섭생, 말 조심"},"u兌l巽":{"no":28,"nameHan":"大過","nameKo":"대과","upper":"兌","lower":"巽","summary":"지나침, 과부하를 바로잡아라"},"u坎l坎":{"no":29,"nameHan":"坎","nameKo":"감","upper":"坎","lower":"坎","summary":"험난·반복 속 체득"},"u離l離":{"no":30,"nameHan":"離","nameKo":"리","upper":"離","lower":"離","summary":"빛과 명료, 의지를 붙들라"},"u兌l艮":{"no":31,"nameHan":"咸","nameKo":"함","upper":"兌","lower":"艮","summary":"감응과 끌림, 상호 매력"},"u震l巽":{"no":32,"nameHan":"恒","nameKo":"항","upper":"震","lower":"巽","summary":"지속과 지조, 꾸준함"},"u乾l艮":{"no":33,"nameHan":"遯","nameKo":"둔","upper":"乾","lower":"艮","summary":"물러남, 때를 기다리는 퇴각"},"u震l乾":{"no":34,"nameHan":"大壯","nameKo":"대장","upper":"震","lower":"乾","summary":"큰 힘의 발휘, 무리하지 말라"},"u離l坤":{"no":35,"nameHan":"晉","nameKo":"진","upper":"離","lower":"坤","summary":"전진·승진, 낮에서 높으로"},"u坤l離":{"no":36,"nameHan":"明夷","nameKo":"명이","upper":"坤","lower":"離","summary":"빛이 상함, 숨고 보존하라"},"u巽l離":{"no":37,"nameHan":"家人","nameKo":"가인","upper":"巽","lower":"離","summary":"가정과 역할 질서"},"u離l兌":{"no":38,"nameHan":"睽","nameKo":"규","upper":"離","lower":"兌","summary":"엇갈림과 불화, 차이의 인정"},"u坎l艮":{"no":39,"nameHan":"蹇","nameKo":"건","upper":"坎","lower":"艮","summary":"난관·지체, 우회하라"},"u震l坎":{"no":40,"nameHan":"解","nameKo":"해","upper":"震","lower":"坎","summary":"풀림과 해결, 사면"},"u艮l兌":{"no":41,"nameHan":"損","nameKo":"손","upper":"艮","lower":"兌","summary":"감소·비움, 자발적 절제"},"u巽l震":{"no":42,"nameHan":"益","nameKo":"익","upper":"巽","lower":"震","summary":"증가·보상, 도움 주고 받기"},"u兌l乾":{"no":43,"nameHan":"夬","nameKo":"쾌","upper":"兌","lower":"乾","summary":"단호한 결단의 선포"},"u乾l巽":{"no":44,"nameHan":"姤","nameKo":"구","upper":"乾","lower":"巽","summary":"뜻밖의 만남, 경계 유지"},"u兌l坤":{"no":45,"nameHan":"萃","nameKo":"췌","upper":"兌","lower":"坤","summary":"모임·수합, 동원"},"u坤l巽":{"no":46,"nameHan":"升","nameKo":"승","upper":"坤","lower":"巽","summary":"오름·승진, 점진적 성장"},"u兌l坎":{"no":47,"nameHan":"困","nameKo":"곤","upper":"兌","lower":"坎","summary":"곤궁·압박, 내적 힘"},"u坎l巽":{"no":48,"nameHan":"井","nameKo":"정","upper":"坎","lower":"巽","summary":"우물·자원, 공익과 재분배"},"u兌l離":{"no":49,"nameHan":"革","nameKo":"혁","upper":"兌","lower":"離","summary":"변혁과 탈피, 새 질서"},"u離l巽":{"no":50,"nameHan":"鼎","nameKo":"정","upper":"離","lower":"巽","summary":"솥·조리, 프로젝트 완성"},"u震l震":{"no":51,"nameHan":"震","nameKo":"진","upper":"震","lower":"震","summary":"충격과 각성, 시작의 우레"},"u艮l艮":{"no":52,"nameHan":"艮","nameKo":"간","upper":"艮","lower":"艮","summary":"그침·멈춤, 명상과 경계"},"u巽l艮":{"no":53,"nameHan":"漸","nameKo":"점","upper":"巽","lower":"艮","summary":"점진·서서히 성숙"},"u震l兌":{"no":54,"nameHan":"歸妹","nameKo":"귀매","upper":"震","lower":"兌","summary":"불균형한 결합, 임시적 동맹"},"u震l離":{"no":55,"nameHan":"豐","nameKo":"풍","upper":"震","lower":"離","summary":"풍요의 절정, 가시성"},"u離l艮":{"no":56,"nameHan":"旅","nameKo":"려","upper":"離","lower":"艮","summary":"나그네, 임시·경계 지키기"},"u巽l巽":{"no":57,"nameHan":"巽","nameKo":"손","upper":"巽","lower":"巽","summary":"스며듦, 점진 침투"},"u兌l兌":{"no":58,"nameHan":"兌","nameKo":"태","upper":"兌","lower":"兌","summary":"기쁨과 열린 교류"},"u巽l坎":{"no":59,"nameHan":"渙","nameKo":"환","upper":"巽","lower":"坎","summary":"흩어짐·분산, 정화"},"u坎l兌":{"no":60,"nameHan":"節","nameKo":"절","upper":"坎","lower":"兌","summary":"규범·절제, 한정"},"u巽l兌":{"no":61,"nameHan":"中孚","nameKo":"중부","upper":"巽","lower":"兌","summary":"성실·진정성, 내적 신뢰"},"u震l艮":{"no":62,"nameHan":"小過","nameKo":"소과","upper":"震","lower":"艮","summary":"작은 과도, 조심스런 진전"},"u坎l離":{"no":63,"nameHan":"旣濟","nameKo":"기제","upper":"坎","lower":"離","summary":"이미 건넌 뒤의 유지·관리"},"u離l坎":{"no":64,"nameHan":"未濟","nameKo":"미제","upper":"離","lower":"坎","summary":"아직 미완, 마무리 전 주의"}};

const POS_LABEL=["1효","2효","3효","4효","5효","6효"];
const POS_ROLE=["(시작·기초)","(관계·내중)","(경계·위험)","(승격·출현)","(지도·외중)","(결말·과함)"];
const POS_DOMAIN=["개인·출발","관계·파트너","경계·갈등","직장·외부","리더십·공적","마무리·과다"];

function toTriChar(bits){ return TRIS[(bits[0]) | (bits[1]<<1) | (bits[2]<<2)]; }
function lookup(hex){
  const low=toTriChar([hex[0],hex[1],hex[2]]), up=toTriChar([hex[3],hex[4],hex[5]]);
  return META['u'+up+'l'+low];
}
function makeTitle(info){
  // 1) 한자 큰 제목: 상·하괘가 같으면 '重+속성+괘명'
  const same = info.upper === info.lower;
  const big = same
    ? '重' + TRI_MEAN_HAN[info.upper] + info.nameHan
    :      TRI_MEAN_HAN[info.upper] + TRI_MEAN_HAN[info.lower] + info.nameHan;

  // 2) 한글 작은 제목:
  //    - 상괘가 震이면 '뇌', 하괘가 震이면 '뢰'
  const attrKoUpper = (info.upper === '震') ? '뇌' : TRI_ATTR_KO[info.upper];
  const attrKoLower = (info.lower === '震') ? '뢰' : TRI_ATTR_KO[info.lower];

  const small = same
    // 동일 상·하괘면 '중 + (하괘 쪽 두음 규칙 적용된 속성) + 괘명'
    ? 'No.' + info.no + ' ' + '중' + attrKoLower + info.nameKo
    // 다르면 기존처럼 '상속성+하속성+괘명' (단, 하괘=震이면 '뢰')
    : 'No.' + info.no + ' ' + attrKoUpper + attrKoLower + info.nameKo;

  const pad2 = n => String(n).padStart(2,'0');
  const href = `./Dict/hex_${pad2(info.no)}_${encodeURIComponent(info.nameKo)}.html`;

  return `<a href="${href}" target="_blank" rel="noopener" class="titleLink">
            <div class="han">${big}</div>
            <div class="ko">${small}</div>
          </a>`;
}
function metaRow(label,tri){ const m=TRI_META[tri];
  return '<div class="metaRow">'
    +'<div class="lab2">'+label+'</div>'
    +'<div class="mono"><b>'+tri+'</b> ('+TRIS_KO[tri]+')</div>'
    +'<div class="mono">'+m.elem+'</div>'
    +'<div>'+m.meaning+'</div>'
    +'<div class="mono">'+m.arrow+' '+m.dir+'</div>'
    +'</div>';
}


function makeInterpretation(changed, vals, info){
  var k = changed.filter(Boolean).length, html = '<h4>해석</h4>';
  if (k===0){
    html += '무변(無變): 현상 유지.';
  } else {
    html += '<div>변효 '+k+'개</div><ul>';
    for (var i=0;i<6;i++){
      if (!changed[i]) continue;
      var dir = (vals[i]===6) ? '음→양(↗ 개시)' : '양→음(↘ 수렴)';
      html += '<li>'+POS_LABEL[i]+' '+POS_ROLE[i]+' · '+dir+'</li>';  // ← li 복구
    }
    html += '</ul>';  // ← 요지 문장 삭제
  }
  return html;
}


function render(prefix, hex, changed, vals, info){
  var hexBox = document.getElementById(prefix+'Hex');
  var title  = document.getElementById(prefix+'Title');
  var metaUnder = document.getElementById(prefix+'Meta');
  var readBox = document.getElementById(prefix+'Read');
  var gist  = document.getElementById(prefix+'gist');

  // 1) 먼저 비우기
  if (hexBox)    hexBox.innerHTML = '';
  if (metaUnder) metaUnder.innerHTML = '';
  if (readBox)   readBox.innerHTML = '';
  if (title)     title.innerHTML = '';
  if (gist)      gist.innerHTML = '';

  // 2) 라인 렌더
  for (var r=5; r>=0; r--){
    var lab  = document.createElement('div'); lab.className='lab'; lab.textContent=(r+1);
    var wrap = document.createElement('div'); wrap.className='lineWrap '+(hex[r]?'yang':'yin')+(changed[r]?' chg':'');
    var line = document.createElement('div'); line.className='line'; wrap.appendChild(line);
    if(!hex[r]){ var gap=document.createElement('div'); gap.className='gap'; wrap.appendChild(gap); }
    if(hexBox){ hexBox.appendChild(lab); hexBox.appendChild(wrap); var sp=document.createElement('div'); sp.className='sp'; hexBox.appendChild(sp); }
  }

  // 3) 제목/메타/요지/해석 채우기
  if (info){
    if (title)     title.innerHTML = makeTitle(info);
        initRadialSpot(title); // ← 이 한 줄
    if (metaUnder) metaUnder.innerHTML = metaRow('상괘', info.upper) + metaRow('하괘', info.lower);
    if (gist){
      var label = (prefix === 'base') ? '본괘 요지' : '변괘 요지';
      gist.innerHTML = '<div class="gistLabel">'+label+'</div>'
                     + '<div class="gistText">'+ info.summary +'</div>';
    }
    if (readBox)   readBox.innerHTML = makeInterpretation(changed, vals, info);
  } else {
    if (title) title.textContent = '—';
  }
}

function initRadialSpot(rootEl){
  const link = rootEl.querySelector('.titleLink');
  if(!link || link.dataset.radialSpotBound) return;

  // 같은 텍스트를 ::after에서 다시 그리기 위해 data-text에 복사
  link.querySelectorAll('.han, .ko')
    .forEach(el => el.setAttribute('data-text', el.textContent));

  // 마우스 위치를 CSS 변수로 넘겨서 라디얼 중심 제어
  let raf = null;
  const onMove = (e)=>{
    const r = link.getBoundingClientRect();
    const x = e.clientX - r.left;
    const y = e.clientY - r.top;
    if(raf) cancelAnimationFrame(raf);
    raf = requestAnimationFrame(()=>{
      link.style.setProperty('--mx', x + 'px');
      link.style.setProperty('--my', y + 'px');
    });
  };

  link.addEventListener('mousemove', onMove);
  link.addEventListener('mouseleave', ()=>{
    link.style.removeProperty('--mx');
    link.style.removeProperty('--my');
  });

  // 중복 바인딩 방지
  link.dataset.radialSpotBound = '1';
}
  
function renderJoint(base, mutated, changed, vals, bInfo, mInfo){
  const s=document.getElementById('jointSummary');
  const d=document.getElementById('jointText');
  if(!s||!d) return;

  const k = changed.filter(Boolean).length;
  let ups=0, downs=0, posArr=[], domains=[];
  for(let i=0;i<6;i++){
    if(changed[i]){
      posArr.push((i+1)+'효'); domains.push(POS_DOMAIN[i]);
      if(vals[i]===6) ups++; else downs++;
    }
  }
  const trend = (ups>downs)?'기세가 열림(↗)':(downs>ups)?'기세가 닫힘(↘)':'균형 전환(→)';

  if(k===0){
    // 기본 문구 먼저 출력
    s.textContent = '변화 없음 — 현상 유지, 내실을 다질 때';
    d.textContent = '현재 #'+bInfo.no+' '+(TRI_MEAN_HAN[bInfo.upper]+TRI_MEAN_HAN[bInfo.lower]+bInfo.nameHan)
      +'('+TRI_ATTR_KO[bInfo.upper]+TRI_ATTR_KO[bInfo.lower]+bInfo.nameKo+')의 기운이 계속됩니다.\n'
      +'급변보다는 안정과 보수에 초점을 두세요.';

    // ⬇️ overrides (no-change) — 있으면 요약/본문을 덮어쓰기
    try{
      window.__overrideLoad && window.__overrideLoad(bInfo.no, bInfo.no).then(ov=>{
        if(!ov) return;
        const box = document.getElementById('jointBox');
        if (box?.classList.contains('ai-owned')) return; // AI가 쓰는 중이면 덮어쓰지 않음

        s.textContent = stripLabelsInline(ov.summary || '');

        const doms = ov.domains || {};
        const body = (stripLabelsInDetail(ov.detail || '') + '\n\n'
          + '· 연애: ' + (doms['연애'] || '') + '\n'
          + '· 사업: ' + (doms['사업'] || '') + '\n'
          + '· 공부: ' + (doms['공부'] || '') + '\n'
          + '· 건강: ' + (doms['건강'] || '')).trim();

        // 안전하게 교체
        d.replaceChildren();
        body.split(/\n+/).filter(Boolean).forEach(p=>{
          const el=document.createElement('p'); el.textContent=p; d.appendChild(el);
        });
      });
    }catch(e){ console.warn(e); }

    return;  // ← 여기서 종료 (변괘 분기로 떨어지지 않게)
  }

  // (k>0) 기본 요약/본문
  s.textContent = '변효 '+k+'개 — '+trend+' · 핵심: '+posArr.join(', ');
  let parts=[];
  parts.push('현재 본괘 '+bInfo.nameKo+'(#'+bInfo.no+', '+TRI_ATTR_KO[bInfo.upper]+TRI_ATTR_KO[bInfo.lower]+')는 "'+bInfo.summary+'"을(를) 뜻합니다.');
  parts.push('변화를 거쳐 변괘 '+mInfo.nameKo+'(#'+mInfo.no+', '+TRI_ATTR_KO[mInfo.upper]+TRI_ATTR_KO[mInfo.lower]+')로 향하며 "'+mInfo.summary+'"의 국면으로 이동합니다.');
  parts.push('이번 변화는 '+domains.join('·')+' 영역에서 두드러집니다.');
  parts.push( (ups>downs)?'막히던 것이 열리거나 새로운 시작의 신호가 강합니다.'
                         : (downs>ups?'과함을 줄이고 정리·수렴하는 흐름이 우세합니다.'
                                   :'팽팽한 균형 속에서 방향 전환의 여지가 큽니다.') );
  d.textContent = parts.join('\n');

  // ⬇️ overrides (changed) — 있으면 덮어쓰기
  try{
    window.__overrideLoad && window.__overrideLoad(bInfo.no, mInfo.no).then(ov=>{
      if(!ov) return;
      const box = document.getElementById('jointBox');
      if (box?.classList.contains('ai-owned')) return;  // AI가 쓰는 중이면 패스

      s.textContent = stripLabelsInline(ov.summary || '');

      const doms = ov.domains || {};
      const body = (stripLabelsInDetail(ov.detail || '') + '\n\n'
        + '· 연애: ' + (doms['연애'] || '') + '\n'
        + '· 사업: ' + (doms['사업'] || '') + '\n'
        + '· 공부: ' + (doms['공부'] || '') + '\n'
        + '· 건강: ' + (doms['건강'] || '')).trim();

      d.replaceChildren();
      body.split(/\n+/).filter(Boolean).forEach(p=>{
        const el=document.createElement('p'); el.textContent=p; d.appendChild(el);
      });
    });
  }catch(e){ console.warn(e); }
}

/******** 랜딩: 커스텀 선택 & 미리보기 ********/
const OPTS=[{v:'',t:'선택'},{v:6,t:'노음'},{v:7,t:'소양'},{v:8,t:'소음'},{v:9,t:'노양'}];
const vals=[null,null,null,null,null,null]; // bottom→top index(0..5)
function drawPreviewBase(base,changed,unsetMask){
  const hexBox=document.getElementById('prevBaseHex'); if(!hexBox) return; hexBox.innerHTML='';
  for(var r=5;r>=0;r--){
    var lab=document.createElement('div'); lab.className='lab'; lab.textContent=(r+1);
    var cls= unsetMask[r] ? 'unset' : (base[r]?'yang':'yin') + (changed[r]?' chg':'');
    var wrap=document.createElement('div'); wrap.className='lineWrap '+cls;
    var line=document.createElement('div'); line.className='line'; wrap.appendChild(line);
    if(!unsetMask[r] && !base[r]){ var gap=document.createElement('div'); gap.className='gap'; wrap.appendChild(gap); }
    hexBox.appendChild(lab); hexBox.appendChild(wrap); var sp=document.createElement('div'); sp.className='sp'; hexBox.appendChild(sp);
  }
}
function live(){
  const base=[],changed=[],unsetMask=[];
  for(let i=0;i<6;i++){
    const v=vals[i];
    if(v===null){ base.push(1); changed.push(false); unsetMask.push(true); }
    else{ const ch=(v===6||v===9), ln=(v===7||v===9)?1:0; base.push(ln); changed.push(ch); unsetMask.push(false); }
  }
  drawPreviewBase(base,changed,unsetMask);
}
function wireSelects(){
  const selects=document.querySelectorAll('#selCol select');
  selects.forEach(sel=>{
    const i=parseInt(sel.getAttribute('data-idx'),10);
    vals[i]= sel.value==='' ? null : parseInt(sel.value,10);
    sel.addEventListener('change',e=>{
      const vv=e.target.value; vals[i]=(vv===''?null:parseInt(vv,10));
      live(); if(vals.every(v=>v!==null)) document.getElementById('msg').classList.add('hidden');
    });
  });
}

/******** 제출 및 실행 ********/
function submitRun(){
  const msg=document.getElementById('msg');
  if(vals.some(v=>v===null)){ msg.classList.remove('hidden'); msg.scrollIntoView({behavior:'smooth',block:'center'}); return; }
  const base=[],changed=[],vv=[];
  for(let i=0;i<6;i++){ const v=vals[i]; vv.push(v); const ch=(v===6||v===9), ln=(v===7||v===9)?1:0; base.push(ln); changed.push(ch); }
  const mutated=base.map((l,i)=> changed[i] ? (l^1) : l);

  document.getElementById('landingUI')?.classList.add('hidden');
  document.getElementById('result')?.classList.remove('hidden');

  const b=lookup(base), m=lookup(mutated);
  
  animateBothAllAtOnce(base, mutated, changed, vv, b, m);
//  requestAI({ method:'custom', question:(document.getElementById('q').value||'').trim(), values:vv, base:b, mutated:m, changed:changed });
}
document.getElementById('btnRun').addEventListener('click', submitRun);

/******** AI 연동 ********/
async function requestAI(payload){
  const st=document.getElementById('aiStatus');
  const out=document.getElementById('aiOut');
  st.textContent='질문과 점괘를 바탕으로 생성 중…'; out.textContent='';

  if(typeof window.aiRequest==='function'){
    try{
      const r=await window.aiRequest(payload);
      const txt=normalizeAI(r);
      st.textContent='완료'; out.textContent=(txt||'').trim(); return;
    }catch(e){ log('aiRequest failed:', e && e.message ? e.message : e); st.textContent='내장 후크 실패. 폴백 시도…'; }
  }

  try{
    const res=await fetch('/api/iching/interpret',{ method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'}, body:JSON.stringify(payload) });
    const ct=(res.headers.get('content-type')||'').toLowerCase();
    if(!res.ok){
      const errBody=ct.includes('application/json') ? JSON.stringify(await res.json()) : (await res.text());
      throw new Error('HTTP '+res.status+' '+res.statusText+' — '+errBody.slice(0,300));
    }
    if(ct.includes('application/json')){
      const data=await res.json(); const txt=normalizeAI(data);
      st.textContent='완료'; out.textContent=(txt||'').trim();
    }else{
      const text=await res.text();
      st.textContent='서버가 JSON이 아닌 응답을 보냈어';
      out.textContent=(text||'').slice(0,400)+((text||'').length>400?'\n…':'')+'\n\n※ /api/iching/interpret 라우트가 SPA index.html 또는 404 HTML을 반환하고 있어. 백엔드에서 JSON을 반환하도록 연결해줘.';
    }
  }catch(e){
    st.textContent='AI 호출 실패';
    out.textContent='요청 실패: '+(e && e.message ? e.message : e)+'\n\n• 원인: 엔드포인트가 JSON을 돌려주지 않음(대개 404/리다이렉트/SPA HTML).\n• 해결:\n  1) window.aiRequest(payload) 전역 후크 구현, 또는\n  2) /api/iching/interpret 가 JSON {text:string} 를 반환하도록 백엔드 라우팅.';
    log('fallback error detail', e && (e.stack || e.message));
  }

  function normalizeAI(x){
    if(typeof x==='string') return x;
    if(!x) return '';
    if(x.text) return x.text;
    if(x.message) return x.message;
    try{
      if(Array.isArray(x.choices) && x.choices[0]){
        const c=x.choices[0];
        if(c.message && c.message.content) return c.message.content;
        if(c.text) return c.text;
      }
    }catch(_){}
    return typeof x==='object'? JSON.stringify(x): String(x);
  }
}
  
/******** 초기화 ********/
window.addEventListener('DOMContentLoaded', ()=>{ try{ wireSelects(); live(); } catch(e){ log('init error', e && (e.message||e)); }});

function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

/** 커스텀용: 여섯 효를 '동시에' 공개 */
async function animateBothAllAtOnce(base, mutated, changed, vals, bInfo, mInfo, delay=500){
  const baseHex  = document.getElementById('baseHex');
  const mutHex   = document.getElementById('mutHex');
  const baseCard = document.getElementById('cardBase');
  const mutCard  = document.getElementById('cardMut');
  const joint    = document.querySelector('.joint');

  // 텍스트/라인 준비: 숨김 상태 세팅
  baseHex?.classList.add('animating');
  mutHex?.classList.add('animating');
  baseCard?.classList.add('prehide','animating');
  mutCard?.classList.add('prehide','animating');
  joint?.classList.add('prehide','animating');

  // 전환 복구(다음 프레임부터 트랜지션 활성)
  requestAnimationFrame(()=>{
    baseCard?.classList.remove('prehide');
    mutCard?.classList.remove('prehide');
    joint?.classList.remove('prehide');
  });

  // 둘 다 먼저 렌더(텍스트는 아직 가림)
  render('base', base,    changed, vals, bInfo);
  render('mut',  mutated, changed, vals, mInfo);

  // 라인들 초기화 → 동시에 공개
  const baseWraps = Array.from(baseHex.querySelectorAll('.lineWrap'));
  const mutWraps  = Array.from(mutHex.querySelectorAll('.lineWrap'));
  baseWraps.forEach(w=>w.classList.remove('revealed'));
  mutWraps.forEach(w=>w.classList.remove('revealed'));

  await sleep(10);                    // 한 틱 대기(transition 적용)
  baseWraps.forEach(w=>w.classList.add('revealed'));
  mutWraps.forEach(w=>w.classList.add('revealed'));

  await sleep(delay + 150);           // 라인 ‘툭’ 등장 시간만큼 기다림

  // 라인 애니 종료 → 카드 텍스트/공유해석 일괄 등장
  baseHex?.classList.remove('animating');
  mutHex?.classList.remove('animating');
  baseCard?.classList.remove('animating');
  mutCard?.classList.remove('animating');

  // 공유 해석 채우고 "뾰로롱"
  renderJoint(base, mutated, changed, vals, bInfo, mInfo);
  requestAnimationFrame(()=> joint?.classList.remove('animating'));
}

  // --- AI augment (wrap renderJoint) : coins 방식 그대로 ---
(function(){
  let ctrl = 0;
  async function aiAugment(payload){
    const my = ++ctrl;
    const j = document.getElementById('jointBox');
    const s = document.getElementById('jointSummary');
    const d = document.getElementById('jointText');
    if(!j || !d) return;
    j.classList.add('ai-owned','loading');
    d.replaceChildren();
        
    const loader = document.createElement('div');
    loader.className = 'loader';
        
    loader.innerHTML = `
  <svg viewBox="0 0 512 512" width="45" height="45" aria-hidden="true">
    <!-- 바깥 사각형 -->
    <g class="sq-outer" fill="#E7EEFC">
      <path class="st0" d="M461.19,258.83l-86.11,86.11c-1.56,1.56-1.56,4.09,0,5.66l12.7,12.7c1.56,1.56,4.09,1.56,5.66,0l104.47-104.47c1.56-1.56,1.56-4.09,0-5.66l-104.47-104.47c-1.56-1.56-4.09-1.56-5.66,0l-12.7,12.7c-1.56,1.56-1.56,4.09,0,5.66l86.11,86.11c1.56,1.56,1.56,4.09,0,5.66h0Z"/>
      <path class="st0" d="M253.17,14.11L14.11,253.17c-1.56,1.56-1.56,4.09,0,5.66l239.07,239.07c1.56,1.56,4.09,1.56,5.66,0l104.47-104.47c1.56-1.56,1.56-4.09,0-5.66l-12.7-12.7c-1.56-1.56-4.09-1.56-5.66,0l-86.11,86.11c-1.56,1.56-4.09,1.56-5.66,0L50.81,258.83c-1.56-1.56-1.56-4.09,0-5.66L253.17,50.81c1.56-1.56,4.09-1.56,5.66,0l86.11,86.11c1.56,1.56,4.09,1.56,5.66,0l12.7-12.7c1.56-1.56,1.56-4.09,0-5.66L258.83,14.11c-1.56-1.56-4.09-1.56-5.66,0h0Z"/>
    </g>

    <!-- 중간 사각형 -->
    <g class="sq-mid" fill="#E7EEFC">
      <path class="st0" d="M191.99,344.48l-12.7,12.7c-1.56,1.56-1.56,4.09,0,5.66l73.88,73.88c1.56,1.56,4.09,1.56,5.66,0l73.88-73.88c1.56-1.56,1.56-4.09,0-5.66l-12.7-12.7c-1.56-1.56-4.09-1.56-5.66,0l-55.52,55.52c-1.56,1.56-4.09,1.56-5.66,0l-55.52-55.52c-1.56-1.56-4.09-1.56-5.66,0Z"/>
      <path class="st0" d="M344.48,320.01l12.7,12.7c1.56,1.56,4.09,1.56,5.66,0l73.88-73.88c1.56-1.56,1.56-4.09,0-5.66l-177.89-177.89c-1.56-1.56-4.09-1.56-5.66,0L75.29,253.17c-1.56,1.56-1.56,4.09,0,5.66l73.88,73.88c1.56,1.56,4.09,1.56,5.66,0l12.7-12.7c1.56-1.56,1.56-4.09,0-5.66l-55.52-55.52c-1.56-1.56-1.56-4.09,0-5.66L253.17,111.99c1.56-1.56,4.09-1.56,5.66,0l141.18,141.18c1.56,1.56,1.56,4.09,0,5.66l-55.52,55.52c-1.56,1.56-1.56,4.09,0,5.66h0Z"/>
    </g>

    <!-- 안쪽 사각형 -->
    <g class="sq-inner" fill="#E7EEFC">
      <path class="st0" d="M302.12,179.75l-43.29-43.29c-1.56-1.56-4.09-1.56-5.66,0l-116.7,116.7c-1.56,1.56-1.56,4.09,0,5.66l116.7,116.7c1.56,1.56,4.09,1.56,5.66,0l43.29-43.29c1.56-1.56,1.56-4.09,0-5.66l-12.7-12.7c-1.56-1.56-4.09-1.56-5.66,0l-24.93,24.93c-1.56,1.56-4.09,1.56-5.66,0l-80-80c-1.56-1.56-1.56-4.09,0-5.66l80-80c1.56-1.56,4.09-1.56,5.66,0l24.93,24.93c1.56,1.56,4.09,1.56,5.66,0l12.7-12.7c1.56-1.56,1.56-4.09,0-5.66v.04Z"/>
      <path class="st0" d="M338.82,258.83l-24.93,24.93c-1.56,1.56-1.56,4.09,0,5.66l12.7,12.7c1.56,1.56,4.09,1.56,5.66,0l43.29-43.29c1.56-1.56,1.56-4.09,0-5.66l-43.29-43.29c-1.56-1.56-4.09-1.56-5.66,0l-12.7,12.7c-1.56,1.56-1.56,4.09,0,5.66l24.93,24.93c1.56,1.56,1.56,4.09,0,5.66Z"/>
    </g>
  </svg>
          `;
    d.appendChild(loader);
    s.textContent = 'AI의 맞춤형 해석을 불러오는 중입니다.';

    // ✅ 누적 회전 루프 (각자 다른 각도/속도/휴식/시작지연)
    const ease = 'cubic-bezier(.32,.02,.24,1)';
    const sleep = ms => new Promise(r=>setTimeout(r, ms));
    const alive = () => loader.isConnected && my===ctrl;

    async function spinLoop(el, step, spin, hold, delay){
      if(!el) return;
      if(delay) await sleep(delay);
      let angle = 0;
      while(alive()){
        el.style.transition = `transform ${spin}ms ${ease}`;
        angle += step;                          // 누적 회전
        el.style.transform = `rotate(${angle}deg)`;
        await sleep(spin);
        if(!alive()) break;
        await sleep(hold);                      // 멈춤 구간
      }
    }  

    // 네가 맞춰둔 값 그대로 사용(예: 270/180/360)
    spinLoop(loader.querySelector('.sq-outer'), 180,  800, 600, 1000);
    spinLoop(loader.querySelector('.sq-mid')  , 270, 1100, 300,  650);
    spinLoop(loader.querySelector('.sq-inner'), 360,  900, 500,  500); 
    
    try{
      // 동전법과 동일 엔드포인트 사용
      const res = await fetch('https://iching-ai-ilo2.onrender.com/api/read', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      if(my!==ctrl) return;                 // 최신 요청만 반영
      if(!res.ok) throw new Error('HTTP '+res.status);

      const data = await res.json() || {};
      const reading  = data.reading || {};
      let summary    = (reading.summary || '').trim();
      let analysis   = (reading.analysis || '').trim();
      let advice     = (reading.advice || '').trim();
      let cautions   = (reading.cautions || '').trim();

      // 본문 앞에 요약이 중복되면 제거
      function stripLead(t){ return (summary && t.startsWith(summary)) ? t.slice(summary.length).trim() : t; }
      analysis = stripLead(analysis); advice = stripLead(advice);

      // 문단 중복 제거(동전법과 동일)
      function dedupeParas(t){
        const paras = (t||'').split(/\n+/).map(s=>s.trim()).filter(Boolean);
        return paras.filter((p,i,a)=> a.indexOf(p)===i).join('\n\n');
      }
      analysis = dedupeParas(analysis);
      advice   = dedupeParas(advice);
      cautions = dedupeParas(cautions);

      // 화면 반영
      s.textContent = summary || '요약 없음';
      const parts = [];
      if (analysis) parts.push(analysis);
      if (advice)   parts.push('조언:\n' + advice);
      if (cautions) parts.push('주의:\n' + cautions);
      if (Array.isArray(reading.line_readings) && reading.line_readings.length){
        const lines = reading.line_readings.map(x => `[${x.line}효] ${x.meaning}`).join('\n');
        parts.push(lines);
      }
      if (reading.timing) parts.push('타이밍: ' + reading.timing);
      if (typeof reading.score === 'number') parts.push(`길흉 점수: ${reading.score}/10`);
      d.textContent = parts.join('\n\n');

      // 로더 해제
      j.classList.remove('loading');

    }catch(e){
      if(my!==ctrl) return;
      console.warn('AI enrich fail', e);
      s.textContent = '해석 생성 실패';
      j.classList.remove('loading');
      d.textContent = 'AI 서버 연결에 실패했어요. 잠시 후 다시 시도해 주세요.';
    }
  }

  // renderJoint 끝난 다음 AI 실행하도록 래핑
  if (typeof renderJoint === 'function'){
    const orig = renderJoint;
    renderJoint = function(base, mutated, changed, vals, bInfo, mInfo){
      // 기본(내장) 해석 먼저 렌더
      orig(base, mutated, changed, vals, bInfo, mInfo);

      // 질문 없으면 AI 생략 (동전법과 동일 정책)
      const q = (document.getElementById('userQuestion')?.value || '').trim();
      if(!q) return;

      const changingLines = changed.map((v,i)=> v ? (i+1) : null).filter(Boolean);
      const payload = {
        question: q,
        method: 'custom',
        primary:  { number: bInfo.no, name_han: bInfo.nameHan, name_kr: bInfo.nameKo, pattern: '' },
        relating: { number: mInfo.no, name_han: mInfo.nameHan, name_kr: mInfo.nameKo, pattern: '' },
        changingLines
      };
      aiAugment(payload);
    };
  }
})();

document.addEventListener('DOMContentLoaded', () => {
  const items = [
    ...document.querySelectorAll('.js-reveal') /*,
    ...document.querySelectorAll('[data-reveal-group] > *') */
  ];

  const reduce = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const baseDelay = 800;  // 헤더만 먼저 보이게 잠깐 대기
  const step = 200;       // 항목 간 지연(ms) — 취향껏 120~240 사이로 조절

  items.forEach((el, i) => {
    const delay = baseDelay + i * step;
    setTimeout(() => {
      // reflow로 첫 프레임 확실히 고정
      void el.offsetWidth;
      el.classList.add('show');  // reduce여도 순차 등장(애니 없음)
    }, delay);
  });
});

  (function(){
  const LIMIT = 300; // ← 글자 수 제한 (HTML maxlength와 맞춰줘)
  const ta = document.getElementById('userQuestion');
  const counter = document.getElementById('userQuestionCount');
  if(!ta || !counter) return;
  ta.setAttribute('maxlength', LIMIT); // 혹시 HTML 안 넣었을 때 대비

  // 이모지/한글 조합 고려: UTF-16 길이 대신 그래페임 단위로 카운트
  const gCount = (s) => Array.from(s || '').length;

  const update = () => {
    const len = gCount(ta.value);
    counter.textContent = `${len}/${LIMIT}`;
    counter.classList.toggle('warn', LIMIT - len <= 20 && LIMIT - len >= 0);
    counter.classList.toggle('error', len > LIMIT);
  };

  // 붙여넣기 등으로 maxlength 우회될 때 잘라내기
  ta.addEventListener('input', () => {
    const arr = Array.from(ta.value);
    if (arr.length > LIMIT) {
      ta.value = arr.slice(0, LIMIT).join('');
    }
    update();
  });

  // 한글·일본어 등 IME 조합 종료 시 길이 보정
  ta.addEventListener('compositionend', update);

  // 초기 표시
  update();
})();

</script>
</body>
</html>
