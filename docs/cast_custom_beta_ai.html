<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DIVINA: 커스텀 점괘 (Beta · AI)</title>
<link rel="icon" type="image/svg+xml" href="icon/No49.svg">
<link rel="apple-touch-icon" sizes="180x180" href="icon/No49.png">
<link rel="preload" href="./assets/fonts/NotoSerifCJKkr-Semibold-iching.woff2" as="font" type="font/woff2" crossorigin>
<style>
  @font-face{
  font-family:"NotoSerifCJK-ICHING";
  src:url("./assets/fonts/NotoSerifCJKkr-Semibold-iching.woff2") format("woff2");
  font-weight:600; font-style:normal; font-display:swap;
}
h1{ font-family:"NotoSerifCJK-ICHING","Source Han Serif K",serif; font-weight:600;text-align:center;margin-top:46px;margin-bottom:30px}
.title .han{ font-family:"NotoSerifCJK-ICHING","Source Han Serif K",serif; }
  
  :root{
    --bg:#0c111b; --card:#111a2b; --border:#22304a; --ink:#eaf0ff;
    --muted:#a8b6d7; --accent:#2b8cff; --yang:#e7eefc; --yin:#e7eefc; --mark:#ff6b6b;
    --hexWidth: 192px; --lineHeight: 24px; --rowGap: 12px; --yinGap: 26px;
    --contentMax: 1200px;
    --cardW: 400px; --cardGap: 18px; /* more compact cards */
    --metaCol1: 40px; --metaCol2: 80px; --metaCol3: 50px; --metaCol4: 100px; --metaCol5: 58px; /* tighter grid */
  }
  
  /* 요지(한 줄 요약) */
  .hex-gist{
  font-family: "NotoSerifCJK-ICHING","Source Han Serif K",serif;
  font-weight: 600;
  font-synthesis: none;
  }
  h1,
  .page-title {                /* 페이지 최상단 타이틀에 쓰는 클래스가 있으면 같이 */
  font-family: "NotoSerifCJK-ICHING", serif !important;
  font-weight: 600 !important;
  font-synthesis: none;      /* 가짜 볼드 방지 */
  letter-spacing:0em;     /* 취향 보정 */
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,'Malgun Gothic',Segoe UI,Roboto,sans-serif}
  a{color:inherit}
  h1{font-size:50px;text-align:center;letter-spacing:-.5px;margin-top:46px;margin-bottom:30px}
  .wrap{max-width:var(--contentMax);margin:0 auto;padding:0 16px 40px}
  .btn{background:#de5776;color:#fff;border:0;border-radius:12px;padding:14px 20px;font-weight:700;cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,.2);font-size:1.1rem}
  .btn.subtle{background:#243552;color:#cfe0ff;border:1px solid #2a3b5a}
  .row{display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap;justify-content:center}
  .card{flex:0 1 400px;max-width:480px;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.25)}
  .badge{display:inline-block;background:#1a2540;border:1px solid #2c3b58;border-radius:10px;padding:4px 10px;margin-bottom:10px}
  .title{text-align:center;margin:6px 0 16px}
  .title .han{font-size:45px;letter-spacing:1px;font-weight:700}
  .title .ko{font-size:14px;color:var(--muted);margin-top:4px}

  .hex{min-width: calc(26px + var(--hexWidth) + 26px); display:grid;grid-template-columns:26px auto 26px;row-gap:var(--rowGap);align-items:center}
  .lab{font-size:11px;color:#c2cfe9;text-align:center;padding-top:2px}
  .sp{width:26px;height:var(--lineHeight)}
  .lineWrap{position:relative;width:var(--hexWidth);height:var(--lineHeight);justify-self:center}
  .line{height:100%;border-radius:7px;background:#25324a;position:absolute;inset:0}
  .yang .line::before{content:'';position:absolute;inset:2px;background:#e7eefc;border-radius:5px;box-shadow:inset 0 0 0 1px rgba(0,0,0,.05)}
  .yin .line::before,.yin .line::after{content:'';position:absolute;top:2px;bottom:2px;width:calc(50% - (var(--yinGap)/2));background:#e7eefc;border-radius:5px;box-shadow:inset 0 0 0 1px rgba(0,0,0,.05)}
  .yin .line::before{left:2px} .yin .line::after{right:2px}
  .yin .gap{position:absolute;left:50%;top:2px;bottom:2px;transform:translateX(-50%);width:var(--yinGap);background:#111a2b;border-radius:4px;box-shadow:0 0 0 1px rgba(0,0,0,.12) inset}
  .chg::after{content:'變';position:absolute;right:-8px;top:-4px;background:var(--mark);color:#fff;font-weight:700;font-size:11px;line-height:16px;padding:0 6px;border-radius:6px;box-shadow:0 1px 6px rgba(0,0,0,.3)}
  .unset .line::before{content:'';position:absolute;inset:2px;background:#162338;border-radius:5px;box-shadow:inset 0 0 0 1px rgba(0,0,0,.06)}

  .metaUnder{border-top:1px dashed #2a3b5a;margin-top:8px;padding-top:6px;text-align:center;width:100%}
  .metaRow{display:grid;grid-template-columns:40px 80px 50px 100px 58px;align-items:center;justify-items:start;column-gap:6px;margin:2px 0}
  .metaRow .lab2{color:#a9b8dc;justify-self:start;padding-right:2px}
  .metaRow .mono{font-variant-numeric:tabular-nums}
  .read{margin-top:8px;padding:8px 10px;border:1px solid #2a3b5a;border-radius:10px;background:#1b2b47}
  .read h4{margin:0 0 6px;font-size:15px;color:#cfe0ff}
  .read ul{margin:6px 0 0 18px;padding:0;line-height:1.45}
  .joint{margin-top:22px;padding:28px 28px;border:1px solid #2a3b5a;border-radius:16px;background:#0e172a;text-align:left;width:calc((2 * var(--cardW)) + var(--cardGap));margin-left:auto;margin-right:auto}
  .joint .summary{font-size:25px;font-weight:800;margin:0 0 20px;text-align:center}
  .joint .detail{font-size:17px;line-height:2.0;white-space:pre-line}
  
  .landing{color:#a9b8dc;display:flex;flex-direction:column;align-items:center;text-align:center;}
  .landing .small{color:#fff;display:block;font-size:20px;font-weight:700;text-align:center}
  .landing .center{display:flex;justify-content:center}
  .intro textarea{margin:8px;max-width:500px;width:100%;min-height:140px;background:#0b1324;border:1px solid #2a3b5a;border-radius:12px;color:var(--ink);padding:14px;font-size:16px}
  
  .qWrap{display:flex;flex-direction:column;align-items:center;gap:10px}
  .qWrap textarea{width:min(780px, 92vw);min-height:90px;background:#0f1a2d;color:var(--ink);border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:16px;line-height:1.5}

  .customUI{
  display:grid;
  grid-template-columns:max-content max-content;
  gap:12px;
  width:max-content;
  margin:10px auto 0;
  justify-content:center;
  }
  .selCol{
  position:relative; z-index:2;
  display:grid;
  grid-template-rows:repeat(6, var(--lineHeight));
  row-gap:var(--rowGap);
  justify-items:end;
  }
  .selCol select{width:var(--selW);min-width:var(--selW);max-width:var(--selW);background:#13233d;color:#e9f0ff;border:1px solid #2b3b5b;border-radius:8px;height:var(--lineHeight);font-size:13px;text-align-last:center;-moz-text-align-last:center}
  .prevCol{ position:relative; z-index:1; pointer-events:none;}
    .prevCol .hex{ grid-template-columns:26px auto 0 !important; }
    .prevCol .lab{ grid-column: 1;text-align:center}
  .warn{color:#f52059;font-weight:400;margin-top:10px;margin-bottom:10px}
  .hidden{display:none !important;}

  .panel{display:grid;grid-template-columns:auto;gap:10px;align-items:center;justify-items:center}
  .hex{display:grid;grid-template-columns:26px auto 26px;row-gap:var(--rowGap);align-items:center}
  .lab{text-align:center;font-size:11px;color:#c2cfe9;padding-top:2px}
  
  .gist{margin:10px 0 8px;text-align:center}
  .gist .gistLabel{font-size:14px;color:#9fb1d4;margin-bottom:4px}
  .gist .gistText{font-size:26px;font-family:"NotoSerifCJK-ICHING","Source Han Serif K",serif; font-weight:600; }
  @media (max-width:560px){ .gist .gistText{font-size:22px} }
    
  .ai{margin-top:18px;padding:18px;border:1px dashed #2a3b5a;border-radius:12px;background:#0f1a2d}
  .ai h4{margin:0 0 8px}

  @media (max-width: 560px){
    .customUI{grid-template-columns:auto 1fr;gap:10px}
    .selCol select{font-size:12px}
  }
  
  @media (max-width:940px){
    .card{flex-basis:100%;max-width:480px}
    .joint{width:auto}
  }

  /* ---- lines reveal animation (coins와 동일) ---- */
#baseHex .lineWrap .line,
#mutHex  .lineWrap .line{
  transition: opacity .28s ease, transform .28s ease;
}

/* 애니 중엔 숨김 — revealed 붙은 것만 보이게 */
#baseHex.animating .lineWrap:not(.revealed) .line,
#mutHex.animating  .lineWrap:not(.revealed) .line{
  opacity: 0;
  transform: scaleX(.92);
}

/* 기본: 배지는 항상 보임 */
.lineWrap.chg::after{
  opacity: 1;
  transform: none;
  transition: opacity .28s ease, transform .28s ease;
}

/* 결과 카드 애니메이션 중에만 숨겼다가 revealed 때 보이게 */
#baseHex.animating .lineWrap.chg::after,
#mutHex.animating  .lineWrap.chg::after{
  opacity: 0;
  transform: translateY(-4px);
}
#baseHex.animating .lineWrap.revealed.chg::after,
#mutHex.animating  .lineWrap.revealed.chg::after{
  opacity: 1;
  transform: translateY(0);
}

/* 살짝 튕김 */
@keyframes tossPulse{
  0%{transform:scaleX(.92)} 60%{transform:scaleX(1.02)} 100%{transform:scaleX(1)}
}
#baseHex.animating .lineWrap.revealed .line,
#mutHex.animating  .lineWrap.revealed .line{
  opacity:1; transform:scaleX(1); animation:tossPulse .28s ease-out;
}

/* 카드/공유해석 텍스트는 애니 끝에 한꺼번에 나타나게 */
.card .title, .card .gist, .card .metaUnder, .card .read{ transition: opacity 1s ease, transform 1s ease; }
.card.animating .title, .card.animating .gist, .card.animating .metaUnder, .card.animating .read{ opacity:0; transform:translateY(6px); }

.joint{ transition: opacity 1s ease, transform 1s ease; }
.joint.animating{ opacity:0; transform:translateY(6px); }

/* 첫 프레임 깜빡임 방지용 */
.card.prehide .title, .card.prehide .gist, .card.prehide .metaUnder, .card.prehide .read,
.joint.prehide{ opacity:0; transform:translateY(6px); transition:none !important; }
  
</style>
</head>
<body>
<div class="wrap">
  <h1><a href="index.html" style="text-decoration:none;color:inherit">Divina Studio</a></h1>

  <!-- 랜딩: 질문 + (좌)선택 / (우)본괘 미리보기 -->
  <section id="landingUI" class="intro landing">
    <p>상황과 질문을 상세히 입력해 주세요.<br>미입력 시 기본 점괘 해석만 제공됩니다.<br></p>
    <label class="small" for="userQuestion">질문 입력</label>
    <textarea id="userQuestion" placeholder="예: 이번 이직 제안이 내게 유리할까? 연봉 협상에서 유의점은?"></textarea>
    <div class="center" style="margin-top:10px;margin-bottom:20px">

    <div id="customUI" class="customUI">
      <!-- (좌) 선택란: 정적 6개(6→1효) -->
      <div class="selCol" id="selCol">
        <select data-idx="5"><option value="">선택</option><option value="6">노음</option><option value="7">소양</option><option value="8">소음</option><option value="9">노양</option></select>
        <select data-idx="4"><option value="">선택</option><option value="6">노음</option><option value="7">소양</option><option value="8">소음</option><option value="9">노양</option></select>
        <select data-idx="3"><option value="">선택</option><option value="6">노음</option><option value="7">소양</option><option value="8">소음</option><option value="9">노양</option></select>
        <select data-idx="2"><option value="">선택</option><option value="6">노음</option><option value="7">소양</option><option value="8">소음</option><option value="9">노양</option></select>
        <select data-idx="1"><option value="">선택</option><option value="6">노음</option><option value="7">소양</option><option value="8">소음</option><option value="9">노양</option></select>
        <select data-idx="0"><option value="">선택</option><option value="6">노음</option><option value="7">소양</option><option value="8">소음</option><option value="9">노양</option></select>
      </div>

      <!-- (우) 본괘 미리보기: 기본 미선택 상태 -->
      <div class="prevCol">
        <div class="hex" id="prevBaseHex">
          <div class="lab">6</div><div class="lineWrap unset"><div class="line"></div></div>
          <div class="lab">5</div><div class="lineWrap unset"><div class="line"></div></div>
          <div class="lab">4</div><div class="lineWrap unset"><div class="line"></div></div>
          <div class="lab">3</div><div class="lineWrap unset"><div class="line"></div></div>
          <div class="lab">2</div><div class="lineWrap unset"><div class="line"></div></div>
          <div class="lab">1</div><div class="lineWrap unset"><div class="line"></div></div>
        </div>
      </div>
    </div>

    <div id="msg" class="warn hidden">점괘를 모두 입력해주세요.</div>

    <div style="display:flex;justify-content:center;margin-top:14px;gap:10px">
      <button id="btnRun" class="btn">제출 및 점괘 실행</button>
    </div>
       <div class="legend" style="text-align:center;margin-top:18px;font-size:12px;color:#a4b2d4">© 2025. Zeniac. All Rights Reserved.</div>
  </section>

  <!-- 결과 -->
  <section id="result" class="hidden">
    <div class="row">
      <div class="card" id="cardBase">
        <div class="badge">본괘</div>
        <div class="title" id="baseTitle"></div>
        <div class="panel" id="panelBase">        
          <div class="hex" id="baseHex"></div>
          <div class="gist" id="basegist"></div>
          <div class="metaUnder" id="baseMeta"></div>
        </div>
        <div class="read" id="baseRead"></div>
      </div>
      <div class="card" id="cardMut">
        <div class="badge">변괘</div>
        <div class="title" id="mutTitle"></div>
        <div class="panel" id="panelMut">        
          <div class="hex" id="mutHex"></div>
          <div class="gist" id="mutgist"></div>
          <div class="metaUnder" id="mutMeta"></div>
        </div>
        <div class="read" id="mutRead"></div>
      </div>
    </div>

    <div class="joint">
      <div class="summary" id="jointSummary">해석 준비중…</div>
      <div class="detail" id="jointText"></div>
    </div>

    <div class="ai" id="aiBox">
      <h4>AI 해석</h4>
      <div id="aiStatus" style="font-size:14px;color:#9fb1d4">질문과 점괘를 바탕으로 생성 중…</div>
      <div id="aiOut" style="white-space:pre-line;margin-top:8px"></div>
    </div>

    <div style="display:flex;justify-content:center;margin-top:18px">
      <a class="btn subtle" href="index.html">돌아가기</a>
    </div>
  </section>

  <div class="legend" style="text-align:center;margin-top:18px;font-size:12px;color:#a4b2d4">© 2025. Zeniac. All Rights Reserved.</div>
</div>

<pre id="dbg" style="display:none;position:fixed;right:10px;bottom:10px;max-width:46vw;background:#111a2a;color:#e7efff;border:1px solid #2e3c5a;border-radius:10px;padding:10px 12px;font:12px/1.5 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;z-index:9999;white-space:pre-wrap"></pre>
<script>
const dbg=document.getElementById('dbg');
function log(){ dbg.style.display='block'; dbg.textContent += Array.from(arguments).join(' ') + "\n"; }
window.addEventListener('keydown',e=>{ if(e.shiftKey && e.key.toLowerCase()==='d'){ dbg.style.display = (dbg.style.display==='none'?'block':'none'); }});
</script>

<script>
/******** 데이터 & 유틸 ********/
const TRIS=['坤','震','坎','兌','艮','離','巽','乾'];
const TRIS_KO={'坤':'곤','震':'진','坎':'감','艮':'간','巽':'손','離':'리','兌':'태','乾':'건'};
const TRI_MEAN_HAN={'乾':'天','坤':'地','坎':'水','離':'火','震':'雷','巽':'風','艮':'山','兌':'澤'};
const TRI_ATTR_KO={'乾':'천','坤':'지','坎':'수','離':'화','震':'뇌','巽':'풍','艮':'산','兌':'택'};
const TRI_META={"乾":{"attrHan":"天","attrKo":"천","elem":"金","meaning":"권위·결단","dir":"서북","arrow":"↖"},"坤":{"attrHan":"地","attrKo":"지","elem":"土","meaning":"수용·양육","dir":"서남","arrow":"↙"},"坎":{"attrHan":"水","attrKo":"수","elem":"水","meaning":"심연·위험","dir":"북","arrow":"↑"},"離":{"attrHan":"火","attrKo":"화","elem":"火","meaning":"빛·분별","dir":"남","arrow":"↓"},"震":{"attrHan":"雷","attrKo":"뇌","elem":"木","meaning":"각성·시작","dir":"동","arrow":"→"},"巽":{"attrHan":"風","attrKo":"풍","elem":"木","meaning":"침투·확산","dir":"동남","arrow":"↘"},"艮":{"attrHan":"山","attrKo":"산","elem":"土","meaning":"멈춤·경계","dir":"동북","arrow":"↗"},"兌":{"attrHan":"澤","attrKo":"택","elem":"金","meaning":"기쁨·교류","dir":"서","arrow":"←"}};
const META={"u乾l乾":{"no":1,"nameHan":"乾","nameKo":"건","upper":"乾","lower":"乾","summary":"창조와 시작, 강건한 추진력"},"u坤l坤":{"no":2,"nameHan":"坤","nameKo":"곤","upper":"坤","lower":"坤","summary":"포용과 순응, 넓은 수용력"},"u坎l震":{"no":3,"nameHan":"屯","nameKo":"둔","upper":"坎","lower":"震","summary":"초기 난관, 인내로 방향을 잡아라"},"u艮l坎":{"no":4,"nameHan":"蒙","nameKo":"몽","upper":"艮","lower":"坎","summary":"미덥지 못함, 배움과 길잡이 필요"},"u坎l乾":{"no":5,"nameHan":"需","nameKo":"수","upper":"坎","lower":"乾","summary":"때를 기다림, 준비된 인내"},"u乾l坎":{"no":6,"nameHan":"訟","nameKo":"송","upper":"乾","lower":"坎","summary":"다툼과 논쟁, 원칙과 절제가 해법"},"u坤l坎":{"no":7,"nameHan":"師","nameKo":"사","upper":"坤","lower":"坎","summary":"조직과 규율, 리더십이 필요"},"u坎l坤":{"no":8,"nameHan":"比","nameKo":"비","upper":"坎","lower":"坤","summary":"결합과 친화, 신의 지키기"},"u巽l乾":{"no":9,"nameHan":"小畜","nameKo":"소축","upper":"巽","lower":"乾","summary":"작게 모아 힘을 기르는 때"},"u乾l兌":{"no":10,"nameHan":"履","nameKo":"리","upper":"乾","lower":"兌","summary":"예절과 절도 속의 전진"},"u坤l乾":{"no":11,"nameHan":"泰","nameKo":"태","upper":"坤","lower":"乾","summary":"소통과 상생, 형통함"},"u乾l坤":{"no":12,"nameHan":"否","nameKo":"비","upper":"乾","lower":"坤","summary":"막힘과 단절, 접촉면을 넓혀라"},"u乾l離":{"no":13,"nameHan":"同人","nameKo":"동인","upper":"乾","lower":"離","summary":"공동체와 연대, 뜻을 함께함"},"u離l乾":{"no":14,"nameHan":"大有","nameKo":"대유","upper":"離","lower":"乾","summary":"풍요와 성취, 명성과 소유"},"u坤l艮":{"no":15,"nameHan":"謙","nameKo":"겸","upper":"坤","lower":"艮","summary":"겸손과 절제, 낮을수록 단단하다"},"u震l坤":{"no":16,"nameHan":"豫","nameKo":"예","upper":"震","lower":"坤","summary":"즐거운 준비, 기획과 예비"},"u兌l震":{"no":17,"nameHan":"隨","nameKo":"수","upper":"兌","lower":"震","summary":"따름과 순응, 유연한 전환"},"u艮l巽":{"no":18,"nameHan":"蠱","nameKo":"고","upper":"艮","lower":"巽","summary":"폐단을 고치고 기반을 수리하라"},"u坤l兌":{"no":19,"nameHan":"臨","nameKo":"임","upper":"坤","lower":"兌","summary":"다가감·접근, 상호성"},"u巽l坤":{"no":20,"nameHan":"觀","nameKo":"관","upper":"巽","lower":"坤","summary":"관찰과 통찰, 큰 그림 보기"},"u離l震":{"no":21,"nameHan":"噬嗑","nameKo":"서합","upper":"離","lower":"震","summary":"결단과 집행, 악을 씹어 없애라"},"u艮l離":{"no":22,"nameHan":"賁","nameKo":"비","upper":"艮","lower":"離","summary":"치장과 표현, 아름다움의 배치"},"u艮l坤":{"no":23,"nameHan":"剝","nameKo":"박","upper":"艮","lower":"坤","summary":"깎여 나감, 쇠퇴 속 전환 준비"},"u坤l震":{"no":24,"nameHan":"復","nameKo":"복","upper":"坤","lower":"震","summary":"되돌아옴, 회복과 재기의 시작"},"u乾l震":{"no":25,"nameHan":"無妄","nameKo":"무망","upper":"乾","lower":"震","summary":"사심 없음, 자연스러움이 길"},"u艮l乾":{"no":26,"nameHan":"大畜","nameKo":"대축","upper":"艮","lower":"乾","summary":"큰 길들임, 축적과 자제"},"u艮l震":{"no":27,"nameHan":"頤","nameKo":"이","upper":"艮","lower":"震","summary":"양육과 섭생, 말 조심"},"u兌l巽":{"no":28,"nameHan":"大過","nameKo":"대과","upper":"兌","lower":"巽","summary":"지나침, 과부하를 바로잡아라"},"u坎l坎":{"no":29,"nameHan":"坎","nameKo":"감","upper":"坎","lower":"坎","summary":"험난·반복 속 체득"},"u離l離":{"no":30,"nameHan":"離","nameKo":"리","upper":"離","lower":"離","summary":"빛과 명료, 의지를 붙들라"},"u兌l艮":{"no":31,"nameHan":"咸","nameKo":"함","upper":"兌","lower":"艮","summary":"감응과 끌림, 상호 매력"},"u震l巽":{"no":32,"nameHan":"恆","nameKo":"항","upper":"震","lower":"巽","summary":"지속과 지조, 꾸준함"},"u乾l艮":{"no":33,"nameHan":"遯","nameKo":"둔","upper":"乾","lower":"艮","summary":"물러남, 때를 기다리는 퇴각"},"u震l乾":{"no":34,"nameHan":"大壯","nameKo":"대장","upper":"震","lower":"乾","summary":"큰 힘의 발휘, 무리하지 말라"},"u離l坤":{"no":35,"nameHan":"晉","nameKo":"진","upper":"離","lower":"坤","summary":"전진·승진, 낮에서 높으로"},"u坤l離":{"no":36,"nameHan":"明夷","nameKo":"명이","upper":"坤","lower":"離","summary":"빛이 상함, 숨고 보존하라"},"u巽l離":{"no":37,"nameHan":"家人","nameKo":"가인","upper":"巽","lower":"離","summary":"가정과 역할 질서"},"u離l兌":{"no":38,"nameHan":"睽","nameKo":"규","upper":"離","lower":"兌","summary":"엇갈림과 불화, 차이의 인정"},"u坎l艮":{"no":39,"nameHan":"蹇","nameKo":"건","upper":"坎","lower":"艮","summary":"난관·지체, 우회하라"},"u震l坎":{"no":40,"nameHan":"解","nameKo":"해","upper":"震","lower":"坎","summary":"풀림과 해결, 사면"},"u艮l兌":{"no":41,"nameHan":"損","nameKo":"손","upper":"艮","lower":"兌","summary":"감소·비움, 자발적 절제"},"u巽l震":{"no":42,"nameHan":"益","nameKo":"익","upper":"巽","lower":"震","summary":"증가·보상, 도움 주고 받기"},"u兌l乾":{"no":43,"nameHan":"夬","nameKo":"쾌","upper":"兌","lower":"乾","summary":"단호한 결단의 선포"},"u乾l巽":{"no":44,"nameHan":"姤","nameKo":"구","upper":"乾","lower":"巽","summary":"뜻밖의 만남, 경계 유지"},"u兌l坤":{"no":45,"nameHan":"萃","nameKo":"췌","upper":"兌","lower":"坤","summary":"모임·수합, 동원"},"u坤l巽":{"no":46,"nameHan":"升","nameKo":"승","upper":"坤","lower":"巽","summary":"오름·승진, 점진적 성장"},"u兌l坎":{"no":47,"nameHan":"困","nameKo":"곤","upper":"兌","lower":"坎","summary":"곤궁·압박, 내적 힘"},"u坎l巽":{"no":48,"nameHan":"井","nameKo":"정","upper":"坎","lower":"巽","summary":"우물·자원, 공익과 재분배"},"u兌l離":{"no":49,"nameHan":"革","nameKo":"혁","upper":"兌","lower":"離","summary":"변혁과 탈피, 새 질서"},"u離l巽":{"no":50,"nameHan":"鼎","nameKo":"정","upper":"離","lower":"巽","summary":"솥·조리, 프로젝트 완성"},"u震l震":{"no":51,"nameHan":"震","nameKo":"진","upper":"震","lower":"震","summary":"충격과 각성, 시작의 우레"},"u艮l艮":{"no":52,"nameHan":"艮","nameKo":"간","upper":"艮","lower":"艮","summary":"그침·멈춤, 명상과 경계"},"u巽l艮":{"no":53,"nameHan":"漸","nameKo":"점","upper":"巽","lower":"艮","summary":"점진·서서히 성숙"},"u震l兌":{"no":54,"nameHan":"歸妹","nameKo":"귀매","upper":"震","lower":"兌","summary":"불균형한 결합, 임시적 동맹"},"u震l離":{"no":55,"nameHan":"豐","nameKo":"풍","upper":"震","lower":"離","summary":"풍요의 절정, 가시성"},"u離l艮":{"no":56,"nameHan":"旅","nameKo":"여","upper":"離","lower":"艮","summary":"나그네, 임시·경계 지키기"},"u巽l巽":{"no":57,"nameHan":"巽","nameKo":"손","upper":"巽","lower":"巽","summary":"스며듦, 점진 침투"},"u兌l兌":{"no":58,"nameHan":"兌","nameKo":"태","upper":"兌","lower":"兌","summary":"기쁨과 열린 교류"},"u巽l坎":{"no":59,"nameHan":"渙","nameKo":"환","upper":"巽","lower":"坎","summary":"흩어짐·분산, 정화"},"u坎l兌":{"no":60,"nameHan":"節","nameKo":"절","upper":"坎","lower":"兌","summary":"규범·절제, 한정"},"u巽l兌":{"no":61,"nameHan":"中孚","nameKo":"중부","upper":"巽","lower":"兌","summary":"성실·진정성, 내적 신뢰"},"u震l艮":{"no":62,"nameHan":"小過","nameKo":"소과","upper":"震","lower":"艮","summary":"작은 과도, 조심스런 진전"},"u坎l離":{"no":63,"nameHan":"既濟","nameKo":"기제","upper":"坎","lower":"離","summary":"이미 건넌 뒤의 유지·관리"},"u離l坎":{"no":64,"nameHan":"未濟","nameKo":"미제","upper":"離","lower":"坎","summary":"아직 미완, 마무리 전 주의"}};

const POS_LABEL=["1효","2효","3효","4효","5효","6효"];
const POS_ROLE=["(시작·기초)","(관계·내중)","(경계·위험)","(승격·출현)","(지도·외중)","(결말·과함)"];
const POS_DOMAIN=["개인·출발","관계·파트너","경계·갈등","직장·외부","리더십·공적","마무리·과다"];

function toTriChar(bits){ return TRIS[(bits[0]) | (bits[1]<<1) | (bits[2]<<2)]; }
function lookup(hex){
  const low=toTriChar([hex[0],hex[1],hex[2]]), up=toTriChar([hex[3],hex[4],hex[5]]);
  return META['u'+up+'l'+low];
}
function makeTitle(info){
  const big=TRI_MEAN_HAN[info.upper]+TRI_MEAN_HAN[info.lower]+info.nameHan;
  const small='No.'+info.no+' '+TRI_ATTR_KO[info.upper]+TRI_ATTR_KO[info.lower]+info.nameKo;
  return '<div class="han">'+big+'</div><div class="ko">'+small+'</div>';
}
function metaRow(label,tri){ const m=TRI_META[tri];
  return '<div class="metaRow">'
    +'<div class="lab2">'+label+'</div>'
    +'<div class="mono"><b>'+tri+'</b> ('+TRIS_KO[tri]+')</div>'
    +'<div class="mono">'+m.elem+'</div>'
    +'<div>'+m.meaning+'</div>'
    +'<div class="mono">'+m.arrow+' '+m.dir+'</div>'
    +'</div>';
}


function makeInterpretation(changed, vals, info){
  var k = changed.filter(Boolean).length, html = '<h4>해석</h4>';
  if (k===0){
    html += '무변(無變): 현상 유지.';
  } else {
    html += '<div>변효 '+k+'개</div><ul>';
    for (var i=0;i<6;i++){
      if (!changed[i]) continue;
      var dir = (vals[i]===6) ? '음→양(↗ 개시)' : '양→음(↘ 수렴)';
      html += '<li>'+POS_LABEL[i]+' '+POS_ROLE[i]+' · '+dir+'</li>';  // ← li 복구
    }
    html += '</ul>';  // ← 요지 문장 삭제
  }
  return html;
}


function render(prefix, hex, changed, vals, info){
  var hexBox = document.getElementById(prefix+'Hex');
  var title  = document.getElementById(prefix+'Title');
  var metaUnder = document.getElementById(prefix+'Meta');
  var readBox = document.getElementById(prefix+'Read');
  var gist  = document.getElementById(prefix+'gist');

  // 1) 먼저 비우기
  if (hexBox)    hexBox.innerHTML = '';
  if (metaUnder) metaUnder.innerHTML = '';
  if (readBox)   readBox.innerHTML = '';
  if (title)     title.innerHTML = '';
  if (gist)      gist.innerHTML = '';

  // 2) 라인 렌더
  for (var r=5; r>=0; r--){
    var lab  = document.createElement('div'); lab.className='lab'; lab.textContent=(r+1);
    var wrap = document.createElement('div'); wrap.className='lineWrap '+(hex[r]?'yang':'yin')+(changed[r]?' chg':'');
    var line = document.createElement('div'); line.className='line'; wrap.appendChild(line);
    if(!hex[r]){ var gap=document.createElement('div'); gap.className='gap'; wrap.appendChild(gap); }
    if(hexBox){ hexBox.appendChild(lab); hexBox.appendChild(wrap); var sp=document.createElement('div'); sp.className='sp'; hexBox.appendChild(sp); }
  }

  // 3) 제목/메타/요지/해석 채우기
  if (info){
    if (title)     title.innerHTML = makeTitle(info);
    if (metaUnder) metaUnder.innerHTML = metaRow('상괘', info.upper) + metaRow('하괘', info.lower);
    if (gist){
      var label = (prefix === 'base') ? '본괘 요지' : '변괘 요지';
      gist.innerHTML = '<div class="gistLabel">'+label+'</div>'
                     + '<div class="gistText">'+ info.summary +'</div>';
    }
    if (readBox)   readBox.innerHTML = makeInterpretation(changed, vals, info);
  } else {
    if (title) title.textContent = '—';
  }
}

  
function renderJoint(base, mutated, changed, vals, bInfo, mInfo){
  var s=document.getElementById('jointSummary'), d=document.getElementById('jointText'); if(!s||!d) return;
  var k=changed.filter(Boolean).length, ups=0,downs=0,posArr=[],domains=[];
  for(var i=0;i<6;i++){ if(changed[i]){ posArr.push((i+1)+'효'); domains.push(POS_DOMAIN[i]); if(vals[i]===6) ups++; else downs++; } }
  var trend=(ups>downs)?'기세가 열림(↗)':(downs>ups)?'기세가 닫힘(↘)':'균형 전환(→)';
  if(k===0){
    s.textContent='변화 없음 — 현상 유지, 내실을 다질 때';
    d.textContent='현재 #'+bInfo.no+' '+(TRI_MEAN_HAN[bInfo.upper]+TRI_MEAN_HAN[bInfo.lower]+bInfo.nameHan)+'('+TRI_ATTR_KO[bInfo.upper]+TRI_ATTR_KO[bInfo.lower]+bInfo.nameKo+')의 기운이 계속됩니다.\n급변보다는 안정과 보수에 초점을 두세요.'; return;
  }
  s.textContent='변효 '+k+'개 — '+trend+' · 핵심: '+posArr.join(', ');
  var parts=[];
  parts.push('현재 본괘 '+bInfo.nameKo+'(#'+bInfo.no+', '+TRI_ATTR_KO[bInfo.upper]+TRI_ATTR_KO[bInfo.lower]+')는 "'+bInfo.summary+'"을(를) 뜻합니다.');
  parts.push('변화를 거쳐 변괘 '+mInfo.nameKo+'(#'+mInfo.no+', '+TRI_ATTR_KO[mInfo.upper]+TRI_ATTR_KO[mInfo.lower]+')로 향하며 "'+mInfo.summary+'"의 국면으로 이동합니다.');
  parts.push('이번 변화는 '+domains.join('·')+' 영역에서 두드러집니다.');
  parts.push( (ups>downs)?'막히던 것이 열리거나 새로운 시작의 신호가 강합니다.':(downs>ups?'과함을 줄이고 정리·수렴하는 흐름이 우세합니다.':'팽팽한 균형 속에서 방향 전환의 여지가 큽니다.') );
  d.textContent=parts.join('\n');
}

/******** 랜딩: 커스텀 선택 & 미리보기 ********/
const OPTS=[{v:'',t:'선택'},{v:6,t:'노음'},{v:7,t:'소양'},{v:8,t:'소음'},{v:9,t:'노양'}];
const vals=[null,null,null,null,null,null]; // bottom→top index(0..5)
function drawPreviewBase(base,changed,unsetMask){
  const hexBox=document.getElementById('prevBaseHex'); if(!hexBox) return; hexBox.innerHTML='';
  for(var r=5;r>=0;r--){
    var lab=document.createElement('div'); lab.className='lab'; lab.textContent=(r+1);
    var cls= unsetMask[r] ? 'unset' : (base[r]?'yang':'yin') + (changed[r]?' chg':'');
    var wrap=document.createElement('div'); wrap.className='lineWrap '+cls;
    var line=document.createElement('div'); line.className='line'; wrap.appendChild(line);
    if(!unsetMask[r] && !base[r]){ var gap=document.createElement('div'); gap.className='gap'; wrap.appendChild(gap); }
    hexBox.appendChild(lab); hexBox.appendChild(wrap); var sp=document.createElement('div'); sp.className='sp'; hexBox.appendChild(sp);
  }
}
function live(){
  const base=[],changed=[],unsetMask=[];
  for(let i=0;i<6;i++){
    const v=vals[i];
    if(v===null){ base.push(1); changed.push(false); unsetMask.push(true); }
    else{ const ch=(v===6||v===9), ln=(v===7||v===9)?1:0; base.push(ln); changed.push(ch); unsetMask.push(false); }
  }
  drawPreviewBase(base,changed,unsetMask);
}
function wireSelects(){
  const selects=document.querySelectorAll('#selCol select');
  selects.forEach(sel=>{
    const i=parseInt(sel.getAttribute('data-idx'),10);
    vals[i]= sel.value==='' ? null : parseInt(sel.value,10);
    sel.addEventListener('change',e=>{
      const vv=e.target.value; vals[i]=(vv===''?null:parseInt(vv,10));
      live(); if(vals.every(v=>v!==null)) document.getElementById('msg').classList.add('hidden');
    });
  });
}

/******** 제출 및 실행 ********/
function submitRun(){
  const msg=document.getElementById('msg');
  if(vals.some(v=>v===null)){ msg.classList.remove('hidden'); msg.scrollIntoView({behavior:'smooth',block:'center'}); return; }
  const base=[],changed=[],vv=[];
  for(let i=0;i<6;i++){ const v=vals[i]; vv.push(v); const ch=(v===6||v===9), ln=(v===7||v===9)?1:0; base.push(ln); changed.push(ch); }
  const mutated=base.map((l,i)=> changed[i] ? (l^1) : l);

  document.getElementById('landing').classList.add('hidden');
  document.getElementById('result').classList.remove('hidden');

  const b=lookup(base), m=lookup(mutated);
  
  animateBothAllAtOnce(base, mutated, changed, vv, b, m);
  requestAI({ method:'custom', question:(document.getElementById('q').value||'').trim(), values:vv, base:b, mutated:m, changed:changed });
}
document.getElementById('btnRun').addEventListener('click', submitRun);

/******** AI 연동 ********/
async function requestAI(payload){
  const st=document.getElementById('aiStatus');
  const out=document.getElementById('aiOut');
  st.textContent='질문과 점괘를 바탕으로 생성 중…'; out.textContent='';

  if(typeof window.aiRequest==='function'){
    try{
      const r=await window.aiRequest(payload);
      const txt=normalizeAI(r);
      st.textContent='완료'; out.textContent=(txt||'').trim(); return;
    }catch(e){ log('aiRequest failed:', e && e.message ? e.message : e); st.textContent='내장 후크 실패. 폴백 시도…'; }
  }

  try{
    const res=await fetch('/api/iching/interpret',{ method:'POST', headers:{'Content-Type':'application/json','Accept':'application/json'}, body:JSON.stringify(payload) });
    const ct=(res.headers.get('content-type')||'').toLowerCase();
    if(!res.ok){
      const errBody=ct.includes('application/json') ? JSON.stringify(await res.json()) : (await res.text());
      throw new Error('HTTP '+res.status+' '+res.statusText+' — '+errBody.slice(0,300));
    }
    if(ct.includes('application/json')){
      const data=await res.json(); const txt=normalizeAI(data);
      st.textContent='완료'; out.textContent=(txt||'').trim();
    }else{
      const text=await res.text();
      st.textContent='서버가 JSON이 아닌 응답을 보냈어';
      out.textContent=(text||'').slice(0,400)+((text||'').length>400?'\n…':'')+'\n\n※ /api/iching/interpret 라우트가 SPA index.html 또는 404 HTML을 반환하고 있어. 백엔드에서 JSON을 반환하도록 연결해줘.';
    }
  }catch(e){
    st.textContent='AI 호출 실패';
    out.textContent='요청 실패: '+(e && e.message ? e.message : e)+'\n\n• 원인: 엔드포인트가 JSON을 돌려주지 않음(대개 404/리다이렉트/SPA HTML).\n• 해결:\n  1) window.aiRequest(payload) 전역 후크 구현, 또는\n  2) /api/iching/interpret 가 JSON {text:string} 를 반환하도록 백엔드 라우팅.';
    log('fallback error detail', e && (e.stack || e.message));
  }

  function normalizeAI(x){
    if(typeof x==='string') return x;
    if(!x) return '';
    if(x.text) return x.text;
    if(x.message) return x.message;
    try{
      if(Array.isArray(x.choices) && x.choices[0]){
        const c=x.choices[0];
        if(c.message && c.message.content) return c.message.content;
        if(c.text) return c.text;
      }
    }catch(_){}
    return typeof x==='object'? JSON.stringify(x): String(x);
  }
}
  
/******** 초기화 ********/
window.addEventListener('DOMContentLoaded', ()=>{ try{ wireSelects(); live(); } catch(e){ log('init error', e && (e.message||e)); }});

function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

/** 커스텀용: 여섯 효를 '동시에' 공개 */
async function animateBothAllAtOnce(base, mutated, changed, vals, bInfo, mInfo, delay=500){
  const baseHex  = document.getElementById('baseHex');
  const mutHex   = document.getElementById('mutHex');
  const baseCard = document.getElementById('cardBase');
  const mutCard  = document.getElementById('cardMut');
  const joint    = document.querySelector('.joint');

  // 텍스트/라인 준비: 숨김 상태 세팅
  baseHex?.classList.add('animating');
  mutHex?.classList.add('animating');
  baseCard?.classList.add('prehide','animating');
  mutCard?.classList.add('prehide','animating');
  joint?.classList.add('prehide','animating');

  // 전환 복구(다음 프레임부터 트랜지션 활성)
  requestAnimationFrame(()=>{
    baseCard?.classList.remove('prehide');
    mutCard?.classList.remove('prehide');
    joint?.classList.remove('prehide');
  });

  // 둘 다 먼저 렌더(텍스트는 아직 가림)
  render('base', base,    changed, vals, bInfo);
  render('mut',  mutated, changed, vals, mInfo);

  // 라인들 초기화 → 동시에 공개
  const baseWraps = Array.from(baseHex.querySelectorAll('.lineWrap'));
  const mutWraps  = Array.from(mutHex.querySelectorAll('.lineWrap'));
  baseWraps.forEach(w=>w.classList.remove('revealed'));
  mutWraps.forEach(w=>w.classList.remove('revealed'));

  await sleep(10);                    // 한 틱 대기(transition 적용)
  baseWraps.forEach(w=>w.classList.add('revealed'));
  mutWraps.forEach(w=>w.classList.add('revealed'));

  await sleep(delay + 150);           // 라인 ‘툭’ 등장 시간만큼 기다림

  // 라인 애니 종료 → 카드 텍스트/공유해석 일괄 등장
  baseHex?.classList.remove('animating');
  mutHex?.classList.remove('animating');
  baseCard?.classList.remove('animating');
  mutCard?.classList.remove('animating');

  // 공유 해석 채우고 "뾰로롱"
  renderJoint(base, mutated, changed, vals, bInfo, mInfo);
  requestAnimationFrame(()=> joint?.classList.remove('animating'));
}
  
</script>
</body>
</html>
