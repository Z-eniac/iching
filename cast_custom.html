<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>주역 캐스터 - 커스텀 점괘 입력</title>
<style>

  :root{
    --bg:#0c111b; --card:#111a2b; --border:#22304a; --ink:#eaf0ff;
    --muted:#a8b6d7; --accent:#2b8cff; --yang:#e7eefc; --yin:#e7eefc; --mark:#ff6b6b;
    --hexWidth: 192px; --lineHeight: 24px; --rowGap: 12px; --yinGap: 26px;
    --contentMax: 1200px;
    --cardW: 360px; --cardGap: 18px; /* more compact cards */
    --metaCol1: 38px; --metaCol2: 75px; --metaCol3: 45px; --metaCol4: 95px; --metaCol5: 53px; /* tighter grid */
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,'Malgun Gothic',Segoe UI,Roboto,sans-serif}
  .wrap{max-width:var(--contentMax);margin:0 auto;padding:90px 12px 0}
  h1{font-size:60px;margin:0 0 34px;text-align:center;letter-spacing:1.2px} /* 1.5x */
  .btns{display:flex;justify-content:center;gap:14px;margin:12px 0 34px}
  button{background:var(--accent);color:#fff;border:0;border-radius:12px;padding:14px 20px;font-weight:600;cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,.2);font-size:1.2rem} /* 1.2x text */
  .row{display:flex;gap:var(--cardGap);align-items:flex-start;flex-wrap:wrap;justify-content:center}
  .card{flex:0 1 var(--cardW);max-width:var(--cardW);background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.25)}
  .badge{display:inline-block;background:#1a2540;border:1px solid #2c3b58;border-radius:10px;padding:4px 10px;margin-bottom:8px}
  .title{text-align:center;margin:6px 0 8px}
  .title .han{font-size:36px;font-weight:900;letter-spacing:1px}
  .title .ko{font-size:14px;color:var(--muted);margin-top:4px}
  .panel{display:grid;grid-template-columns:auto;gap:10px;align-items:center;justify-items:center}
  .hex{display:grid;grid-template-columns:26px auto 26px;row-gap:var(--rowGap);align-items:center}
  .lab{text-align:center;font-size:11px;color:#c2cfe9;padding-top:2px}
  .sp{width:26px;height:var(--lineHeight)}
  .lineWrap{position:relative;width:var(--hexWidth);height:var(--lineHeight);justify-self:center}
  .line{height:100%;border-radius:7px;background:#25324a;position:absolute;inset:0}
  .yang .line::before{content:'';position:absolute;inset:2px;background:var(--yang);border-radius:5px;box-shadow:inset 0 0 0 1px rgba(0,0,0,.05)}
  .yin .line::before, .yin .line::after{content:'';position:absolute;top:2px;bottom:2px;width:calc(50% - (var(--yinGap)/2));background:var(--yin);border-radius:5px;box-shadow:inset 0 0 0 1px rgba(0,0,0,.05)}
  .yin .line::before{left:2px} .yin .line::after{right:2px}
  .yin .gap{position:absolute;left:50%;top:2px;bottom:2px;transform:translateX(-50%);width:var(--yinGap);background:#111a2b;border-radius:4px;box-shadow:0 0 0 1px rgba(0,0,0,.12) inset}
  .chg::after{content:'變';position:absolute;right:-8px;top:-4px;background:var(--mark);color:#fff;font-weight:600;font-size:11px;line-height:16px;padding:0 6px;border-radius:6px;box-shadow:0 1px 6px rgba(0,0,0,.3)}
  /* Meta under hex - fixed columns, tighter */
  .metaUnder{border-top:1px dashed #2a3b5a;margin-top:8px;padding-top:6px;text-align:center;width:100%}
  .metaRow{display:grid;grid-template-columns:var(--metaCol1) var(--metaCol2) var(--metaCol3) var(--metaCol4) var(--metaCol5);align-items:center;justify-items:start;column-gap:6px;margin:2px 0}
  .metaRow .lab2{color:#a9b8dc;justify-self:end;padding-right:2px}
  .metaRow .mono{font-variant-numeric:tabular-nums}
  .kw{display:none}
  .read{margin-top:8px;padding:8px 10px;border:1px solid #2a3b5a;border-radius:10px;background:#0f1a2e}
  .read h4{margin:0 0 6px;font-size:15px;color:#cfe0ff}
  .read ul{margin:6px 0 0 18px;padding:0;line-height:1.45}
  /* Joint interpretation area */
  .joint{margin-top:22px;padding:28px 28px;border:1px solid #2a3b5a;border-radius:16px;background:#0e172a;text-align:left;width:calc((2 * var(--cardW)) + var(--cardGap));margin-left:auto;margin-right:auto}
  .joint .summary{font-size:30px;font-weight:900;margin:0 0 16px;text-align:center}
  .joint .detail{font-size:19px;line-height:2.0;white-space:pre-line}
  .legend{margin-top:12px;margin-bottom:20px;font-size:12px;color:#a4b2d4;text-align:center}
  @media (max-width:860px){
    .card{flex-basis:100%;max-width:640px}
    .joint{width:auto}
  }


/* === Gist headline style (match coins/yarrow pages) === */
.panel .gist{margin:10px 0 8px;text-align:center}
.panel .gistLabel{font-size:14px;color:#9fb1d4;margin-bottom:4px}
.panel .gistText{font-size:26px;font-weight:900;letter-spacing:.2px;color:#eaf1ff}
@media (max-width: 860px){
  .panel .gistText{ font-size:34px; }
  .panel .gistLabel{ font-size:18px; }
}

.centerTop{display:flex;flex-direction:column;align-items:center;margin:18px 0 6px}
.centerTop .run{background:#7c8bf5;color:#fff;border:0;border-radius:14px;padding:12px 18px;font-weight:900;cursor:pointer}
.warn{color:#f52059;font-weight:400;margin-top:10px;margin-bottom:10px}
.hidden{display:none !important;}
.unset .line::before{content:'';position:absolute;inset:2px;background:#162338;border-radius:5px;box-shadow:inset 0 0 0 1px rgba(0,0,0,.06)}
.debugBox{position:fixed;right:10px;bottom:10px;max-width:46vw;background:#111a2a;color:#e7efff;border:1px solid #2e3c5a;border-radius:10px;padding:10px 12px;font:12px/1.5 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;z-index:9999;display:none;white-space:pre-wrap}
.debugBox b{color:#9bdcff}
  /* 커스텀 입력 헤더 & 선택창 가운데 정렬 */
.customInline {            /* 커스텀 입력 전체 박스 */
  display: flex;
  flex-direction: column;
  align-items: center;     /* 가로 중앙 */
}

.customInline .ciHead {    /* "커스텀 입력" 제목 */
  text-align: center;
}

.customInline .ciGrid {    /* 선택상자 컨테이너 */
  display: flex;
  flex-direction: column;
  align-items: center;     /* 내부 항목 중앙 */
  gap: 10px;
}

.customInline .ciGrid select {
  display: block;          /* margin: auto가 먹도록 */
  margin: 0 auto;
  width: 180px;            /* 필요 시 폭 고정 */
  text-align-last: center; /* 선택된 값 중앙(크롬/사파리) */
  -moz-text-align-last: center; /* 파폭 */
}
</style>
</head>
<body>
<div style="display:none">
  <button id="castCoins"></button>
  <button id="castYarrow"></button>
  <button id="customInput"></button>
</div>

<div class="mainWrap">
  <h1 class="title">주역 캐스터</h1>

  <div class="centerTop">
    <button id="btnSubmit" class="run">제출</button>
    <div id="msg" class="warn hidden">점괘를 모두 입력해주세요.</div>
  </div>

  <div class="row">
    <div class="card" id="cardBase">
      <div class="badge">본괘</div>
      <div class="panel" id="panelBase">
        <div class="title" id="baseTitle"></div>
        <div class="hex" id="baseHex"></div>
        <div class="gist"><div class="gistLabel">본괘 요지</div><div class="gistText" id="baseGist"></div></div>
        <div class="metaUnder" id="baseMeta"></div>
      </div>
      <div id="inlineCustom" class="customInline">
        <div class="ciHead">커스텀 입력</div>
        <div class="ciGrid"> … <select> … </select> … </div>
      </div>
      <div class="read" id="baseRead"></div>
    </div>

    <div class="card" id="cardMut">
      <div class="badge">변괘</div>
      <div class="panel" id="panelMut">
        <div class="title" id="mutTitle"></div>
        <div class="hex" id="mutHex"></div>
        <div class="gist"><div class="gistLabel">변괘 요지</div><div class="gistText" id="mutGist"></div></div>
        <div class="metaUnder" id="mutMeta"></div>
      </div>
      <div class="read" id="mutRead"></div>
    </div>
  </div>

  <div class="joint">
    <div class="summary" id="jointSummary">버튼을 눌러 점을 시작하세요.</div>
    <div class="detail" id="jointText"></div>
  </div>

  <div class="bottomNav" style="display:flex;justify-content:center;margin:18px 0 10px">
    <a href="index.html" class="btnBack" style="background:#243552;color:#cfe0ff;border:1px solid #2a3b5a;border-radius:12px;padding:10px 16px;font-weight:700;text-decoration:none">← 돌아가기</a>
  </div>
</div>

<div id="dbg" class="debugBox"></div>
  
<script>

const META = {"u乾l乾": {"no": 1, "nameHan": "乾", "nameKo": "건", "upper": "乾", "lower": "乾", "summary": "창조와 시작, 강건한 추진력"}, "u坤l坤": {"no": 2, "nameHan": "坤", "nameKo": "곤", "upper": "坤", "lower": "坤", "summary": "포용과 순응, 넓은 수용력"}, "u坎l震": {"no": 3, "nameHan": "屯", "nameKo": "둔", "upper": "坎", "lower": "震", "summary": "초기 난관, 인내로 방향을 잡아라"}, "u艮l坎": {"no": 4, "nameHan": "蒙", "nameKo": "몽", "upper": "艮", "lower": "坎", "summary": "미덥지 못함, 배움과 길잡이가 필요하다"}, "u坎l乾": {"no": 5, "nameHan": "需", "nameKo": "수", "upper": "坎", "lower": "乾", "summary": "때를 기다림, 준비된 인내"}, "u乾l坎": {"no": 6, "nameHan": "訟", "nameKo": "송", "upper": "乾", "lower": "坎", "summary": "다툼과 논쟁, 원칙과 절제가 해법"}, "u坤l坎": {"no": 7, "nameHan": "師", "nameKo": "사", "upper": "坤", "lower": "坎", "summary": "조직과 규율, 리더십이 필요"}, "u坎l坤": {"no": 8, "nameHan": "比", "nameKo": "비", "upper": "坎", "lower": "坤", "summary": "결합과 친화, 신의 지키기"}, "u巽l乾": {"no": 9, "nameHan": "小畜", "nameKo": "소축", "upper": "巽", "lower": "乾", "summary": "작게 모아 힘을 기르는 때"}, "u乾l兌": {"no": 10, "nameHan": "履", "nameKo": "리", "upper": "乾", "lower": "兌", "summary": "예절과 절도 속의 전진"}, "u坤l乾": {"no": 11, "nameHan": "泰", "nameKo": "태", "upper": "坤", "lower": "乾", "summary": "소통과 상생, 형통함"}, "u乾l坤": {"no": 12, "nameHan": "否", "nameKo": "비", "upper": "乾", "lower": "坤", "summary": "막힘과 단절, 접촉면을 넓혀라"}, "u乾l離": {"no": 13, "nameHan": "同人", "nameKo": "동인", "upper": "乾", "lower": "離", "summary": "공동체와 연대, 뜻을 함께함"}, "u離l乾": {"no": 14, "nameHan": "大有", "nameKo": "대유", "upper": "離", "lower": "乾", "summary": "풍요와 성취, 명성과 소유"}, "u坤l艮": {"no": 15, "nameHan": "謙", "nameKo": "겸", "upper": "坤", "lower": "艮", "summary": "겸손과 절제, 낮을수록 단단하다"}, "u震l坤": {"no": 16, "nameHan": "豫", "nameKo": "예", "upper": "震", "lower": "坤", "summary": "즐거운 준비, 기획과 예비"}, "u兌l震": {"no": 17, "nameHan": "隨", "nameKo": "수", "upper": "兌", "lower": "震", "summary": "따름과 순응, 유연한 전환"}, "u艮l巽": {"no": 18, "nameHan": "蠱", "nameKo": "고", "upper": "艮", "lower": "巽", "summary": "폐단을 고치고 기반을 수리하라"}, "u坤l兌": {"no": 19, "nameHan": "臨", "nameKo": "임", "upper": "坤", "lower": "兌", "summary": "다가감·접근, 상호성"}, "u巽l坤": {"no": 20, "nameHan": "觀", "nameKo": "관", "upper": "巽", "lower": "坤", "summary": "관찰과 통찰, 큰 그림 보기"}, "u離l震": {"no": 21, "nameHan": "噬嗑", "nameKo": "서합", "upper": "離", "lower": "震", "summary": "결단과 집행, 악을 씹어 없애라"}, "u艮l離": {"no": 22, "nameHan": "賁", "nameKo": "비", "upper": "艮", "lower": "離", "summary": "치장과 표현, 아름다움의 배치"}, "u艮l坤": {"no": 23, "nameHan": "剝", "nameKo": "박", "upper": "艮", "lower": "坤", "summary": "깎여 나감, 쇠퇴 속 전환 준비"}, "u坤l震": {"no": 24, "nameHan": "復", "nameKo": "복", "upper": "坤", "lower": "震", "summary": "되돌아옴, 회복과 재기의 시작"}, "u乾l震": {"no": 25, "nameHan": "無妄", "nameKo": "무망", "upper": "乾", "lower": "震", "summary": "사심 없음, 자연스러움이 길"}, "u艮l乾": {"no": 26, "nameHan": "大畜", "nameKo": "대축", "upper": "艮", "lower": "乾", "summary": "큰 길들임, 축적과 자제"}, "u艮l震": {"no": 27, "nameHan": "頤", "nameKo": "이", "upper": "艮", "lower": "震", "summary": "양육과 섭생, 말 조심"}, "u兌l巽": {"no": 28, "nameHan": "大過", "nameKo": "대과", "upper": "兌", "lower": "巽", "summary": "지나침, 과부하를 바로잡아라"}, "u坎l坎": {"no": 29, "nameHan": "坎", "nameKo": "감", "upper": "坎", "lower": "坎", "summary": "험난·반복 속 체득"}, "u離l離": {"no": 30, "nameHan": "離", "nameKo": "리", "upper": "離", "lower": "離", "summary": "빛과 명료, 의지를 붙들라"}, "u兌l艮": {"no": 31, "nameHan": "咸", "nameKo": "함", "upper": "兌", "lower": "艮", "summary": "감응과 끌림, 상호 매력"}, "u震l巽": {"no": 32, "nameHan": "恒", "nameKo": "항", "upper": "震", "lower": "巽", "summary": "지속과 지조, 꾸준함"}, "u乾l艮": {"no": 33, "nameHan": "遯", "nameKo": "둔", "upper": "乾", "lower": "艮", "summary": "물러남, 때를 기다리는 퇴각"}, "u震l乾": {"no": 34, "nameHan": "大壯", "nameKo": "대장", "upper": "震", "lower": "乾", "summary": "큰 힘의 발휘, 무리하지 말라"}, "u離l坤": {"no": 35, "nameHan": "晉", "nameKo": "진", "upper": "離", "lower": "坤", "summary": "전진·승진, 낮에서 높으로"}, "u坤l離": {"no": 36, "nameHan": "明夷", "nameKo": "명이", "upper": "坤", "lower": "離", "summary": "빛이 상함, 숨고 보존하라"}, "u巽l離": {"no": 37, "nameHan": "家人", "nameKo": "가인", "upper": "巽", "lower": "離", "summary": "가정과 역할 질서"}, "u離l兌": {"no": 38, "nameHan": "睽", "nameKo": "규", "upper": "離", "lower": "兌", "summary": "엇갈림과 불화, 차이의 인정"}, "u坎l艮": {"no": 39, "nameHan": "蹇", "nameKo": "건", "upper": "坎", "lower": "艮", "summary": "난관·지체, 우회하라"}, "u震l坎": {"no": 40, "nameHan": "解", "nameKo": "해", "upper": "震", "lower": "坎", "summary": "풀림과 해결, 사면"}, "u艮l兌": {"no": 41, "nameHan": "損", "nameKo": "손", "upper": "艮", "lower": "兌", "summary": "감소·비움, 자발적 절제"}, "u巽l震": {"no": 42, "nameHan": "益", "nameKo": "익", "upper": "巽", "lower": "震", "summary": "증가·보상, 도움 주고 받기"}, "u兌l乾": {"no": 43, "nameHan": "夬", "nameKo": "쾌", "upper": "兌", "lower": "乾", "summary": "단호한 결단의 선포"}, "u乾l巽": {"no": 44, "nameHan": "姤", "nameKo": "구", "upper": "乾", "lower": "巽", "summary": "뜻밖의 만남, 경계 유지"}, "u兌l坤": {"no": 45, "nameHan": "萃", "nameKo": "췌", "upper": "兌", "lower": "坤", "summary": "모임·수합, 동원"}, "u坤l巽": {"no": 46, "nameHan": "升", "nameKo": "승", "upper": "坤", "lower": "巽", "summary": "오름·승진, 점진적 성장"}, "u兌l坎": {"no": 47, "nameHan": "困", "nameKo": "곤", "upper": "兌", "lower": "坎", "summary": "곤궁·압박, 내적 힘"}, "u坎l巽": {"no": 48, "nameHan": "井", "nameKo": "정", "upper": "坎", "lower": "巽", "summary": "우물·자원, 공익과 재분배"}, "u兌l離": {"no": 49, "nameHan": "革", "nameKo": "혁", "upper": "兌", "lower": "離", "summary": "변혁과 탈피, 새 질서"}, "u離l巽": {"no": 50, "nameHan": "鼎", "nameKo": "정", "upper": "離", "lower": "巽", "summary": "솥·조리, 프로젝트 완성"}, "u震l震": {"no": 51, "nameHan": "震", "nameKo": "진", "upper": "震", "lower": "震", "summary": "충격과 각성, 시작의 우레"}, "u艮l艮": {"no": 52, "nameHan": "艮", "nameKo": "간", "upper": "艮", "lower": "艮", "summary": "그침·멈춤, 명상과 경계"}, "u巽l艮": {"no": 53, "nameHan": "漸", "nameKo": "점", "upper": "巽", "lower": "艮", "summary": "점진·서서히 성숙"}, "u震l兌": {"no": 54, "nameHan": "歸妹", "nameKo": "귀매", "upper": "震", "lower": "兌", "summary": "불균형한 결합, 임시적 동맹"}, "u震l離": {"no": 55, "nameHan": "豐", "nameKo": "풍", "upper": "震", "lower": "離", "summary": "풍요의 절정, 가시성"}, "u離l艮": {"no": 56, "nameHan": "旅", "nameKo": "여", "upper": "離", "lower": "艮", "summary": "나그네, 임시·경계 지키기"}, "u巽l巽": {"no": 57, "nameHan": "巽", "nameKo": "손", "upper": "巽", "lower": "巽", "summary": "스며듦, 점진 침투"}, "u兌l兌": {"no": 58, "nameHan": "兌", "nameKo": "태", "upper": "兌", "lower": "兌", "summary": "기쁨과 열린 교류"}, "u巽l坎": {"no": 59, "nameHan": "渙", "nameKo": "환", "upper": "巽", "lower": "坎", "summary": "흩어짐·분산, 정화"}, "u坎l兌": {"no": 60, "nameHan": "節", "nameKo": "절", "upper": "坎", "lower": "兌", "summary": "규범·절제, 한정"}, "u巽l兌": {"no": 61, "nameHan": "中孚", "nameKo": "중부", "upper": "巽", "lower": "兌", "summary": "성실·진정성, 내적 신뢰"}, "u震l艮": {"no": 62, "nameHan": "小過", "nameKo": "소과", "upper": "震", "lower": "艮", "summary": "작은 과도, 조심스런 진전"}, "u坎l離": {"no": 63, "nameHan": "既濟", "nameKo": "기제", "upper": "坎", "lower": "離", "summary": "이미 건넌 뒤의 유지·관리"}, "u離l坎": {"no": 64, "nameHan": "未濟", "nameKo": "미제", "upper": "離", "lower": "坎", "summary": "아직 미완, 마무리 전 주의"}};
const TRIS = ['坤','震','坎','艮','巽','離','兌','乾']; // 000..111 (bottom-up)
const TRIS_KO = {'坤':'곤','震':'진','坎':'감','艮':'간','巽':'손','離':'리','兌':'태','乾':'건'};
const TRI_MEAN_HAN = {'乾':'天','坤':'地','坎':'水','離':'火','震':'雷','巽':'風','艮':'山','兌':'澤'};
const TRI_ATTR_KO  = {'乾':'천','坤':'지','坎':'수','離':'화','震':'뇌','巽':'풍','艮':'산','兌':'택'};
const TRI_META = {"乾": {"attrHan": "天", "attrKo": "천", "elem": "金", "meaning": "권위·결단", "dir": "서북", "arrow": "↖"}, "坤": {"attrHan": "地", "attrKo": "지", "elem": "土", "meaning": "수용·양육", "dir": "서남", "arrow": "↙"}, "坎": {"attrHan": "水", "attrKo": "수", "elem": "水", "meaning": "심연·위험", "dir": "북", "arrow": "↑"}, "離": {"attrHan": "火", "attrKo": "화", "elem": "火", "meaning": "빛·분별", "dir": "남", "arrow": "↓"}, "震": {"attrHan": "雷", "attrKo": "뇌", "elem": "木", "meaning": "각성·시작", "dir": "동", "arrow": "→"}, "巽": {"attrHan": "風", "attrKo": "풍", "elem": "木", "meaning": "침투·확산", "dir": "동남", "arrow": "↘"}, "艮": {"attrHan": "山", "attrKo": "산", "elem": "土", "meaning": "멈춤·경계", "dir": "동북", "arrow": "↗"}, "兌": {"attrHan": "澤", "attrKo": "택", "elem": "金", "meaning": "기쁨·교류", "dir": "서", "arrow": "←"}};

const POS_LABEL = ["1효","2효","3효","4효","5효","6효"];
const POS_ROLE  = ["(시작·기초)","(관계·내중)","(경계·위험)","(승격·출현)","(지도·외중)","(결말·과함)"];
const POS_DOMAIN = ["개인·출발","관계·파트너","경계·갈등","직장·외부","리더십·공적","마무리·과다"];

function triIndex(bits){ return bits[0] | (bits[1]<<1) | (bits[2]<<2); }
function toTriChar(bits){ return TRIS[triIndex(bits)]; }

function rollYarrow(){ const r = crypto.getRandomValues(new Uint8Array(1))[0] & 15; if(r===0) return 6; if(r<=5) return 7; if(r<=12) return 8; return 9; }
function rollCoins(){ const r = crypto.getRandomValues(new Uint8Array(1))[0] & 7; if(r===0) return 6; if(r<=3) return 7; if(r<=6) return 8; return 9; }
function toLine(v){ if(v===6) return {line:0,changing:true,val:6}; if(v===9) return {line:1,changing:true,val:9}; if(v===7) return {line:1,changing:false,val:7}; return {line:0,changing:false,val:8}; }

function cast(method){
  const base=[], changed=[], vals=[];
  for(let i=0;i<6;i++){
    const v = (method==='yarrow') ? rollYarrow() : rollCoins();
    const o = toLine(v);
    base.push(o.line); changed.push(o.changing); vals.push(o.val);
  }
  const mutated=base.map((l,i)=> changed[i] ? (l^1) : l);
  const bInfo = lookup(base);
  const mInfo = lookup(mutated);
  render('base', base, changed, vals, bInfo);
  render('mut',  mutated, changed, vals, mInfo);
  renderJoint(base, mutated, changed, vals, bInfo, mInfo);
}

function lookup(hex){
  const low = toTriChar([hex[0],hex[1],hex[2]]);
  const up  = toTriChar([hex[3],hex[4],hex[5]]);
  return META['u'+up+'l'+low];
}

function makeTitle(info){
  const big = TRI_MEAN_HAN[info.upper] + TRI_MEAN_HAN[info.lower] + info.nameHan;
  const small = 'No.' + info.no + ' ' + TRI_ATTR_KO[info.upper] + TRI_ATTR_KO[info.lower] + info.nameKo;
  return '<div class="han">'+big+'</div><div class="ko">'+small+'</div>';
}

function metaRow(label, tri){
  const m = TRI_META[tri];
  return '<div class="metaRow">'
    + '<div class="lab2">'+label+'</div>'
    + '<div class="mono"><b>'+tri+'</b> ('+TRIS_KO[tri]+')</div>'
    + '<div class="mono">'+m.elem+'</div>'
    + '<div>'+m.meaning+'</div>'
    + '<div class="mono">'+m.arrow+' '+m.dir+'</div>'
    + '</div>';
}

function makeInterpretation(changed, vals, info){
  var k = changed.filter(Boolean).length;
  var html = '<h4>해석</h4>';
  if (k===0) {
    html += '무변: 현상 유지. ' + info.summary;
  } else {
    html += '<div>변효 ' + k + '개</div><ul>';
    for (var i=0;i<6;i++) {
      if (!changed[i]) continue;
      var dir = (vals[i]===6) ? '음→양(↗ 개시)' : '양→음(↘ 수렴)';
      html += '<li>' + POS_LABEL[i] + ' ' + POS_ROLE[i] + ' · ' + dir + '</li>';
    }
    html += '</ul><div style="margin-top:6px">→ 점괘 요지: ' + info.summary + '</div>';
  }
  return html;
}

function render(prefix, hex, changed, vals, info){
  var hexBox=document.getElementById(prefix+'Hex');
  var title =document.getElementById(prefix+'Title');
  var metaUnder=document.getElementById(prefix+'Meta');
  var readBox=document.getElementById(prefix+'Read');
  hexBox.innerHTML=''; metaUnder.innerHTML=''; readBox.innerHTML=''; title.innerHTML='';
  for (var r=5; r>=0; r--) {
    var lab=document.createElement('div'); lab.className='lab'; lab.textContent=(r+1);
    var wrap=document.createElement('div'); wrap.className='lineWrap ' + (hex[r]?'yang':'yin') + (changed[r]?' chg':'');
    var line=document.createElement('div'); line.className='line'; wrap.appendChild(line);
    if(!hex[r]){ var gap=document.createElement('div'); gap.className='gap'; wrap.appendChild(gap); }
    hexBox.appendChild(lab); hexBox.appendChild(wrap);
    var sp=document.createElement('div'); sp.className='sp'; hexBox.appendChild(sp);
  }
  if (info){
    title.innerHTML = makeTitle(info);
    metaUnder.innerHTML = metaRow('상괘', info.upper) + metaRow('하괘', info.lower);
    readBox.innerHTML = makeInterpretation(changed, vals, info);
  } else { title.textContent='—'; }
}

function renderJoint(base, mutated, changed, vals, bInfo, mInfo){
  var s = document.getElementById('jointSummary');
  var d = document.getElementById('jointText');
  var k = changed.filter(Boolean).length;
  var ups = 0, downs = 0, posArr = [];
  for (var i=0;i<6;i++){ if(changed[i]){ posArr.push((i+1)+'효'); if(vals[i]===6) ups++; else downs++; } }
  var trend = (ups>downs) ? '기세가 열림(↗)' : (downs>ups) ? '기세가 닫힘(↘)' : '균형 전환(→)';
  var domains = changed.map((c,i)=> c? POS_DOMAIN[i] : null).filter(Boolean);
  if(k===0){
    s.textContent = '변화 없음 — 현상 유지, 내실을 다질 때';
    d.textContent = '현재 #'+bInfo.no+' '+(TRI_MEAN_HAN[bInfo.upper]+TRI_MEAN_HAN[bInfo.lower]+bInfo.nameHan)+'('+TRI_ATTR_KO[bInfo.upper]+TRI_ATTR_KO[bInfo.lower]+bInfo.nameKo+')의 기운이 계속됩니다.\n급변보다는 안정과 보수에 초점을 두세요.';
    return;
  }
  s.textContent = '변효 '+k+'개 — '+trend+' · 핵심: '+posArr.join(', ');
  var parts = [];
  parts.push('현재 본괘 '+bInfo.nameKo+'(#'+bInfo.no+', '+TRI_ATTR_KO[bInfo.upper]+TRI_ATTR_KO[bInfo.lower]+')는 "'+bInfo.summary+'"을(를) 뜻합니다.');
  parts.push('변화를 거쳐 변괘 '+mInfo.nameKo+'(#'+mInfo.no+', '+TRI_ATTR_KO[mInfo.upper]+TRI_ATTR_KO[mInfo.lower]+')로 향하며 "'+mInfo.summary+'"의 국면으로 이동합니다.');
  parts.push('이번 변화는 '+domains.join('·')+' 영역에서 두드러집니다.');
  parts.push( (ups>downs) ? '막히던 것이 열리거나 새로운 시작의 신호가 강합니다.' : (downs>ups ? '과함을 줄이고 정리·수렴하는 흐름이 우세합니다.' : '팽팽한 균형 속에서 방향 전환의 여지가 큽니다.') );
  var advice = [];
  if (k===1){ advice.push('한 지점만 바로잡아도 전체가 따라옵니다. 해당 자리의 덕목을 실천하세요.'); }
  if (k>=4){ advice.push('대세 전환기입니다. 낡은 규칙을 과감히 정리하고 새 질서를 준비하세요.'); }
  if (mInfo.upper===bInfo.upper && mInfo.lower!==bInfo.lower){ advice.push('외부 틀은 유지되나 내부 기반이 달라집니다. 안을 먼저 정비하세요.'); }
  if (mInfo.upper!==bInfo.upper && mInfo.lower===bInfo.lower){ advice.push('내부는 그대로, 외부 환경이 바뀝니다. 대외 대응을 조정하세요.'); }
  if (TRI_META[mInfo.upper].elem!==TRI_META[bInfo.upper].elem && TRI_META[mInfo.lower].elem!==TRI_META[bInfo.lower].elem){ advice.push('오행 상호작용이 전면 교체됩니다. 단번에 모두 바꾸기보다 단계적으로 전환하세요.'); }
  if (!advice.length){ advice.push('바뀌는 쪽의 장점을 선택하되, 본괘의 강점은 잃지 마세요.'); }
  parts = parts.concat(advice);
  d.textContent = parts.join('\n');
}

document.getElementById('castYarrow').onclick = function(){ cast('yarrow'); };
document.getElementById('castCoins').onclick = function(){ cast('coins'); };
function renderBlank(){
  render('base',[1,1,1,1,1,1],[false,false,false,false,false,false],[7,7,7,7,7,7],null);
  render('mut',[1,1,1,1,1,1],[false,false,false,false,false,false],[7,7,7,7,7,7],null);
  document.getElementById('jointSummary').textContent = '버튼을 눌러 점을 시작하세요.';
  document.getElementById('jointText').textContent = '';
}
renderBlank();

;try{ if(typeof lookup!=='undefined') window.lookup = lookup; }catch(e){}
;try{ if(typeof render!=='undefined') window.render = render; }catch(e){}
;try{ if(typeof renderJoint!=='undefined') window.renderJoint = renderJoint; }catch(e){}
;try{ if(typeof renderBlank!=='undefined') window.renderBlank = renderBlank; }catch(e){}

</script>

<script>
(function(){
  const dbg = document.getElementById('dbg');
  function log(...a){ dbg.innerHTML += a.join(' ')+'\n'; }
  window.addEventListener('keydown',e=>{ if(e.shiftKey && e.key.toLowerCase()==='d') dbg.style.display=(dbg.style.display==='none'?'block':'none'); });

  function ensureEl(id, parentSel, html){ 
    if(document.getElementById(id)){ log('ensure:', id, 'ok'); return; }
    const p=document.querySelector(parentSel); if(!p){ log('ensure fail:', id, 'parent', parentSel, 'not found'); return; }
    const d=document.createElement('div'); d.id=id; if(html) d.innerHTML=html;
    p.appendChild(d); log('ensure:', id, 'created');
  }
  // 필수 컨테이너 보장
  ensureEl('baseTitle','#panelBase','<div class="title" id="baseTitle"></div>');
  ensureEl('mutTitle','#panelMut','<div class="title" id="mutTitle"></div>');
  ensureEl('baseHex','#panelBase','<div class="hex" id="baseHex"></div>');
  ensureEl('mutHex','#panelMut','<div class="hex" id="mutHex"></div>');
  ensureEl('baseGist','#panelBase','<div class="gistText" id="baseGist"></div>');
  ensureEl('mutGist','#panelMut','<div class="gistText" id="mutGist"></div>');
  ensureEl('baseMeta','#panelBase','<div class="metaUnder" id="baseMeta"></div>');
  ensureEl('mutMeta','#panelMut','<div class="metaUnder" id="mutMeta"></div>');
  ensureEl('baseRead','#cardBase','<div class="read" id="baseRead"></div>');
  ensureEl('mutRead','#cardMut','<div class="read" id="mutRead"></div>');
  ensureEl('jointSummary','.joint','<div class="summary" id="jointSummary"></div>');
  ensureEl('jointText','.joint','<div class="detail" id="jointText"></div>');

  const grid = document.querySelector('.ciGrid');
  const btn  = document.getElementById('btnSubmit');
  const msg  = document.getElementById('msg');
  if(!grid){ log('ciGrid not found'); return; }

  const vals = [null,null,null,null,null,null];
  const OPTS = [
    {v:'', t:'선택'},
    {v:6,  t:'노음 [- -변효]'},
    {v:7,  t:'소양 [---무변효]'},
    {v:8,  t:'소음 [- -무변효]'},
    {v:9,  t:'노양 [---변효]'}
  ];

  function drawPreview(prefix, base, changed, unsetMask){
    var hexBox=document.getElementById(prefix+'Hex'); if(!hexBox){ log('drawPreview missing', prefix+'Hex'); return; }
    hexBox.innerHTML='';
    for (var r=5; r>=0; r--){
      var lab=document.createElement('div'); lab.className='lab'; lab.textContent=(r+1);
      var cls = unsetMask[r] ? 'unset' : (base[r] ? 'yang' : 'yin') + (changed[r]?' chg':'');
      var wrap=document.createElement('div'); wrap.className='lineWrap ' + cls;
      var line=document.createElement('div'); line.className='line'; wrap.appendChild(line);
      if(!unsetMask[r] && !base[r]){ var gap=document.createElement('div'); gap.className='gap'; wrap.appendChild(gap); }
      hexBox.appendChild(lab); hexBox.appendChild(wrap);
      var sp=document.createElement('div'); sp.className='sp'; hexBox.appendChild(sp);
    }
  }

  function live(){
    const base=[], changed=[], unsetMask=[];
    for(let i=0;i<6;i++){ 
      const v = vals[i];
      if(v===null){ base.push(1); changed.push(false); unsetMask.push(true); }
      else{ const ch=(v===6||v===9), ln=(v===7||v===9)?1:0; base.push(ln); changed.push(ch); unsetMask.push(false);}
    }
    const mutated = base.map((l,i)=> changed[i] ? (l^1) : l);
    drawPreview('base',base,changed,unsetMask);
    drawPreview('mut', mutated,changed,unsetMask);
  }

  function build(){
    grid.innerHTML='';
    for(let i=5;i>=0;i--){
      const lab=document.createElement('div'); lab.className='lab'; lab.textContent=(i+1)+'효';
      const sel=document.createElement('select'); sel.setAttribute('data-idx', String(i));
      OPTS.forEach(o=>{ const op=document.createElement('option'); op.value=String(o.v); op.textContent=o.t; sel.appendChild(op); });
      sel.value='';
      sel.addEventListener('change',(e)=>{ 
        const v=e.target.value; vals[i]=(v===''?null:parseInt(v,10)); 
        live();
        if(vals.every(v=>v!==null)) msg.classList.add('hidden');
      });
      grid.appendChild(lab); grid.appendChild(sel);
    }
  }

  function moveGist(prefix){
    const read=document.getElementById(prefix+'Read');
    const gist=document.getElementById(prefix+'Gist');
    if(!read || !gist) return;
    let node=null;
    Array.from(read.querySelectorAll('*')).some(el=>{
      const t=el.textContent.trim();
      if(/^→\s*점괘\s*요지\s*:/.test(t)){ node=el; return true; }
      return false;
    });
    let text='';
    if(node){ text = node.textContent.replace(/^.*?:\s*/,'').trim(); node.remove(); }
    else {
      const m = read.innerText.split('\n').find(l=>/^→\s*점괘\s*요지\s*:/.test(l.trim()));
      if(m) text = m.replace(/^.*?:\s*/,'').trim();
    }
    if(text) gist.textContent = text;
  }

  function robustRender(base, mutated, changed, vv){
    if(typeof window.lookup==='function' && typeof window.render==='function' && typeof window.renderJoint==='function'){
      try{ 
        const b = window.lookup(base), m = window.lookup(mutated);
        window.render('base', base, changed, vv, b);
        window.render('mut',  mutated, changed, vv, m);
        window.renderJoint(base, mutated, changed, vv, b, m);
        moveGist('base'); moveGist('mut');
        log('robustRender: USED ORIGINAL');
        return;
      }catch(e){ log('original render failed:', e.message); }
    } else { log('original functions NOT visible'); }
    // 폴백(최소 표시)
    drawPreview('base', base, changed, [false,false,false,false,false,false]);
    drawPreview('mut',  mutated, changed, [false,false,false,false,false,false]);
    document.getElementById('jointSummary').textContent='요약: 변효 '+changed.filter(Boolean).length+'개';
  }

  function submit(){
    if(vals.some(v=>v===null)){ msg.classList.remove('hidden'); return; }
    const base=[], changed=[], vv=[];
    for(let i=0;i<6;i++){ const v=vals[i]; vv.push(v);
      const ch=(v===6||v===9), ln=(v===7||v===9)?1:0;
      base.push(ln); changed.push(ch);
    }
    const mutated = base.map((l,i)=> changed[i] ? (l^1) : l);
    try{ robustRender(base, mutated, changed, vv); }catch(e){ log('submit error:', e.message); }
    const box=document.getElementById('inlineCustom');
    if (box) {
     box.classList.add('hidden'); // 기본
     box.style.display = 'none';  // 혹시 모를 충돌 대비
     box.setAttribute('aria-hidden', 'true');
    }
    if(btn) btn.classList.add('hidden');
  }

  build(); live();
  btn && btn.addEventListener('click', submit);
})();
</script>
</body>
</html>
